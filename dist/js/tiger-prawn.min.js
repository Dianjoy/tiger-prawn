/*! tiger-prawn Version 0.3.0
 2015-11-26 */
"use strict";!function(){!function(a){var b=a.sync;a.sync=function(c,d,e){if(e=e||{},"success"in e){var f=e.success;e.success=function(b){a.trigger("backbone-sync",b),f.call(e.context,b)}}var g=e.error;return e.error=function(b){a.trigger("backbone-error",b),g&&g(b)},"xhrField"in e?e.xhrFields.withCredentials=!0:e.xhrFields={withCredentials:!0},b(c,d,e)},a.Model.prototype.isNew=function(){return!this.id}}(Backbone),function(a){var b=Array.prototype.slice,c=Array.prototype.pop,d={};a.registerHelper("pick",function(a,c){a=parseInt(a);var d=arguments[arguments.length-1];return d.hash.start=d.hash.start||0,d.hash.key&&c===d&&(c=d.data.root[d.hash.key]),c=_.isArray(c)||_.isObject(c)?c:b.call(arguments,1,-1),c[a-d.hash.start]}),a.registerHelper("pick_with",function(a,d,e){if(a=parseInt(a),d=_.isArray(d)?d:b.call(arguments,1,-1),e=c.call(arguments),_.isObject(d[0])){for(var f,g=e.hash.key||"id",h=0,i=d.length;i>h;h++)if(d[h][g]==a){f=d[h];break}return f?e.fn(f):""}return e.fn(d[a+e.hash.offset])}),a.registerHelper("substring",function(a,b,c){return a?a.substr(b,c):""}),a.registerHelper("text-collapse",function(a,b){return a?a.length<b?a:'<abbr title="'+a+'">'+a.substr(0,b)+"...</abbr>":""}),a.registerHelper("ext",function(a){return a?a.substr(a.lastIndexOf(".")+1):""}),a.registerHelper("d100",function(a){return(a/100).toFixed(2)}),a.registerHelper("short_n",function(a){if(_.isNaN(a))return a;for(var b=["万","亿","万亿"],c=a,d=0;a/1e4>=1;)a/=1e4,c=(a%1===0?a:(100*a>>0)/100)+b[d],d++;return c}),a.registerHelper("readable_n",function(a){a=Number(a),a=a%1===0?a.toString():a.toFixed(2),a=a.replace(".",",");for(var b=/(\d)(\d{3})(,|$)/;b.test(a);)a=a.replace(b,"$1,$2$3");return a=a.replace(/,(\d\d)$/,".$1"),a.replace(/^\./,"0.")}),a.registerHelper("percent",function(a,b){return a=Number(a),isNaN(b)||(a/=b),Math.round(1e4*a)/100}),a.registerHelper("moment",function(a){return a=a?moment(a).calendar():"",/invalid/i.test(a)?"":a}),a.registerHelper("from-now",function(a){return a?moment(a).fromNow():""}),a.registerHelper("to_date",function(a,b){return a?moment(a).add(b,"days").format(moment.DATE_FORMAT):""}),a.registerHelper("equal",function(a,b,c){return a==b?c.fn(this):c.inverse(this)}),a.registerHelper("greater",function(a,b,c){return a>b?c.fn(this):c.inverse(this)}),a.registerHelper("in",function(a,d,e){return _.isArray(d)||(e=c.call(arguments),d=b.call(arguments,1)),-1!==d.indexOf(a)?e.fn(this):e.inverse(this)}),a.registerHelper("raw-helper",function(a){return a.fn()}),a.registerHelper("json",function(a){return JSON.stringify(a)}),a.registerHelper("inject",function(b,c){var d=a.$context;return b=d.getValue(b),b instanceof Backbone.Model?b.get(c):b[c]}),a.registerHelper("counter",function(a){return a=a||"_",d[a]=d[a]||1,d[a]++}),a.registerHelper("counter-reset",function(a){return a=a||"_",d[a]=1,""})}(Handlebars),function(a){a.fn.spinner=function(b){return b=void 0===b?!0:b,this.each(function(c){if("a"===this.tagName.toLowerCase())a(this).toggleClass("disabled",b);else{if("button"!==this.tagName.toLowerCase())return!0;a(this).prop("disabled",b)}a(this).find("i").toggle(!b),b?a(this).prepend(tp.component.spinner):a(this).find(".fa-spin").remove()})}}(jQuery),function(a){a.DATE_FORMAT="YYYY-MM-DD",a.TIME_FORMAT="HH:mm:ss",a.DATETIME_FORMAT=a.defaultFormat="YYYY-MM-DD HH:mm:ss"}(moment),function(){var a={};try{localStorage.setItem("tp",1),localStorage.removeItem("tp")}catch(b){localStorage.setItem=function(b,c){a[b]=c},localStorage.getItem=function(b){return a[b]}}}(),function(a){a.Base=Backbone.Router.extend({$ranger:null,$body:null,$me:null,routes:{"user/:page":"showUserPage","dashboard(/:start/:end)":"showDashboard","my/profile/":"showMyProfile"},showDashboard:function(a,b){a=a||moment().add(1-(new Date).getDate(),"days").format(moment.DATE_FORMAT),b=b||moment().add(-1,"days").format(moment.DATE_FORMAT);var c=this.$me.isCP()?"_cp":"",d=Backbone.Model.extend({url:tp.API+"dashboard/",parse:function(a){return a.data}}),e=new d({start:a,end:b});this.$body.load("page/dashboard"+c+".hbs",e,{refresh:!0,data:{start:a,end:b},loader:tp.view.Dashboard}),this.$body.setFramework("has-date-range dashboard dashboard-"+(this.$me.isCP()?"cp":"sale"),"新近数据统计"),this.$ranger.use(e)},showMyProfile:function(){this.$body.load("page/cp/profile.hbs",this.$me,{data:{full:!0},refresh:!0}),this.$body.setFramework("me profile","我的账户")},showUserPage:function(a){return"logout"===a?this.$me.destroy({success:function(a){a.clear(),location.hash="#/user/login"}}):"login"===a&&this.$me.id?void this.navigate(tp.startPage||"#/dashboard"):(tp.config.login.api=this.$me.url,this.$body.load(tp.path+"page/"+a+".hbs",tp.config.login,{isFull:!0}),void this.$body.setFramework("login","登录"))}})}(Nervenet.createNameSpace("tp.router")),function(a){var b={dataType:"json",type:"post",cache:!1,xhrFields:{withCredentials:!0}},c={$body:null,$me:null,call:function(a,c,d){d=_.extend({url:a,data:c},b,d);var e=this,f=d.error||this.onError,g=d.success||this.onSuccess;d.success=function(a){0===a.code?(e.postHandle(a),g.call(d.context,a),e.trigger("complete:call",a)):f(a)},d.error=function(a,b,c){f.call(d.context,a,b,c)},$.ajax(d)},fetch:function(a,b,c){$.get(a,function(a){b.call(c,a)})},postHandle:function(a){"me"in a&&this.$me.set(a.me)},onError:function(a,b,c){401===b&&this.$body.load("page/error.html")},onProgress:function(a,b){},onSuccess:function(a){}};c=_.extend(c,Backbone.Events),a.Manager=c}(Nervenet.createNameSpace("tp.service")),function(a){var b,c=Backbone.View.extend({$context:null,events:{"click .popup":"popupButton_clickHandler"},initialize:function(){this.template=Handlebars.compile(this.$("#popup").remove().html()),this.editor=Handlebars.compile(this.$("#editor-popup").remove().html())},postConstruct:function(){b&&this.$context.inject(b)},popup:function(b){var c=$(this.template(b)),d=Nervenet.parseNamespace(b.popup)||a.Base;return this.$el.append(c),c=this.$context.createInstance(d,_.extend({el:c},b))},popupEditor:function(a){var b=a.el=$(this.editor(a));return this.$el.append(b),b=d.createEditor(this.$context,a)},popupButton_clickHandler:function(a){var b=a.currentTarget,c=$(b).data();if(c.collectionId){var d=tp.model.ListCollection.getInstance(c);c.model=d.get(c.id)}"a"===b.tagName.toLowerCase()&&(c.content=b.href,c.isRemote=!0),c.title=c.title||b.title,this.popup(c),a.preventDefault()}}),d={createEditor:function(b,c){var d;switch(c.type){case"file":d=b.createInstance(a.FileEditor,c);break;case"number":case"range":d=b.createInstance(a.NumberEditor,c);break;case"search":d=b.createInstance(a.SearchEditor,c);break;case"select":d=b.createInstance(a.SelectEditor,c);break;case"tags":d=b.createInstance(a.TagsEditor,c);break;case"status":d=b.createInstance(a.SwitchEditor,c);break;case"checkbox":d=b.createInstance(a.CheckboxEditor,c);break;case"date":case"time":case"datetime":d=b.createInstance(a.DateTimeEditor,c);break;default:d=b.createInstance(a.Editor,c)}return d}};a.Manager=new c({el:"body"})}(Nervenet.createNameSpace("tp.popup")),function(a){a.decodeURLParam=function(a){if(!a)return{};for(var b=a.split("&"),c={},d=0,e=b.length;e>d;d++){var f=b[d].split("=");c[f[0]]=decodeURIComponent(f[1])}return c},a.convertCurrency=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=99999999999.99,q="零",r="壹",s="贰",t="叁",u="肆",v="伍",w="陆",x="柒",y="捌",z="玖",A="拾",B="佰",C="仟",D="万",E="亿",F="元",G="角",H="分",I="整";if(a=a.toString(),""==a)return alert("Empty input!"),"";if(null!=a.match(/[^,.\d]/))return alert("Invalid characters in the input string!"),"";if(null==a.match(/^((\d{1,3}(,\d{3})*(.((\d{3},)*\d{1,3}))?)|(\d+(.\d+)?))$/))return alert("Illegal format of digit number!"),"";if(a=a.replace(/,/g,""),a=a.replace(/^0+/,""),Number(a)>p)return alert("Too large a number to convert!"),"";if(e=a.split("."),e.length>1?(b=e[0],c=e[1],c=c.substr(0,2)):(b=e[0],c=""),f=[q,r,s,t,u,v,w,x,y,z],g=["",A,B,C],h=["",D,E],i=[G,H],d="",Number(b)>0){for(j=0,k=0;k<b.length;k++)l=b.length-k-1,m=b.substr(k,1),n=l/4,o=l%4,"0"==m?j++:(j>0&&(d+=f[0]),j=0,d+=f[Number(m)]+g[o]),0==o&&4>j&&(d+=h[n]);d+=F}if(""!=c)for(k=0;k<c.length;k++)m=c.substr(k,1),"0"!=m&&(d+=f[Number(m)]+i[k]);return""==d&&(d=q+F),""==c&&(d+=I),d}}(Nervenet.createNameSpace("tp.utils")),function(a){a.Error={getAjaxMessage:function(a,b,c){if("500"===a.statusCode().status)return{message:"服务器错误，请告知管理员",icon:"close"};if(0===a.status)return{message:"连接超时，请检查您的网络。",icon:"close"};var d=(a.responseJSON?a.responseJSON.msg:null)||c||"",e="frown-o";return"error"!==b||a.responseText||(d="请求服务器失败，请重试。若连续失败，请联系管理员。",e="user-md"),{message:d,icon:e}}}}(Nervenet.createNameSpace("tp")),function(a){function b(a,b,c){c.model=a,c.prop=b,tp.popup.Manager.popupEditor(c)}a.editModelCommand=function(a,c,d){d=_.extend({},d),d.value=a.get(c),b(a,c,d)}}(Nervenet.createNameSpace("tp.controller")),function(a){a.addModelCommand=function(a,b){var c=tp.model.ListCollection.getInstance(a),d=new c.model(null,a);a.isRemote=!0,a.content="page/"+a.template,d.options=c.options,d.urlRoot=c.url,d.key=c.key,a.name&&b.mapValue(a.name,d,!0),a.model=d;var e=tp.popup.Manager.popup(a);e.on("success",function(){c.add(d,{immediately:!0,prepend:!0,merge:!0}),a.name&&b.removeValue(a.name)})}}(Nervenet.createNameSpace("tp.controller")),function(a){a.Me=Backbone.Model.extend({$body:null,url:tp.API+"auth/",defaults:{face:"img/logo.png"},initialize:function(){this.on("change:id",this.id_changeHandler,this)},fetch:function(a){Backbone.Model.prototype.fetch.call(this,_.extend({error:_.bind(this.onError,this)},a))},parse:function(a){var b=a.me;return"balance"in b&&(b.amount=b.balance+b.lock,b.money_percent=Math.round(b.balance/b.amount*1e4)/100),b},isCP:function(){return"cp"===this.get("role")},id_changeHandler:function(a,b){if(b)this.$body.start(!0),tp.notification.Manager.start(),setTimeout(function(){var a;if(Backbone.History.started||(a=Backbone.history.start({root:tp.BASE})),!a||/^#\/user\/\w+$/.test(location.hash)){var b=localStorage.getItem(tp.PROJECT+"-from");b=/^#\/user\/log(in|out)$/.test(b)?"":b,location.hash=b||tp.startPage||"#/dashboard"}},10);else if(this.$body.isStart&&"#/user/logout"!==location.hash){var c=tp.config.login;c.welcome="登录已失效，请重新登录",c.api=this.url,tp.popup.Manager.popup(_.extend({title:"登录",content:"page/login.hbs",confirm:"登录",cancel:"退出",isRemote:!0},c))}else localStorage.setItem(tp.PROJECT+"-from",location.hash),location.hash="#/user/login"},onError:function(){this.$body.start(),localStorage.setItem(tp.PROJECT+"-from",location.hash),location.hash="#/user/login",Backbone.history.start({root:tp.BASE})}})}(Nervenet.createNameSpace("tp.model")),function(a){var b={},c=Backbone.Model.extend({parse:function(a){var b=this.key||(this.collection?this.collection.key:"data");return"code"in a&&"msg"in a&&b in a?a[b]:a},toJSON:function(a){var b=Backbone.Model.prototype.toJSON.call(this,a);if(a)return b;var c=this.previousAttributes();return _.isEmpty(c)||(b.previous=c),_.extend(b,this.options,this.collection?this.collection.options:null)}}),d=a.ListCollection=Backbone.Collection.extend({cache:null,total:0,pagesize:10,isLoading:!1,initialize:function(a,b){if(this.key=b.key||"data",this.save=tp.PROJECT+location.hash+"-pagesize",Backbone.Collection.prototype.initialize.call(this,a,b),_.isString(this.model)){var c=Nervenet.parseNamespace(this.model);if(c)this.model=c;else{var d=this;$.getScript(tp.component.Manager.getPath(this.model),function(){d.model=Nervenet.parseNamespace(d.model),d.cache&&(d.cache.options.reset?d.reset(d.cache.response,d.cache.options):(d.set(d.parse(d.cache.response),d.cache.options),d.trigger("sync")),d.cache=null)})}}if(b){b.url&&(this.url=b.url);var e=localStorage.getItem(this.save);this.pagesize=e||b.pagesize||this.pagesize}},fetch:function(a){this.isLoading||(a=a||{},a.data?a.data.pagesize=this.pagesize:a.data={pagesize:this.pagesize},Backbone.Collection.prototype.fetch.call(this,a),this.isLoading=!0)},parse:function(a,b){if(this.isLoading=!1,_.isString(this.model))return this.cache={response:a,options:b},null;this.total=_.isArray(a)?a.length:a.total,a.options&&(this.options=a.options);for(var c in _.omit(a,"total","list","options","code","msg"))a.hasOwnProperty(c)&&(_.isArray(a[c])||_.isObject(a[c]))&&this.trigger("data:"+c,a[c]);return _.isArray(a)?a:a.list},getAmount:function(a){return _.isString(a)&&(a=a.split(" ")),this.reduce(function(b,c){var d=c.omit(a);for(var e in d)isNaN(d[e])||(b[e]=(b[e]?b[e]:0)+Number(d[e]));return b},{amount:!0})},setPagesize:function(a){this.pagesize=a,localStorage.setItem(this.save,a)}}),e=function(a){var b=a.collectionType,c=this;$.getScript(tp.component.Manager.getPath(b),function(){b=Nervenet.parseNamespace(b);var d=c.real=new b(c.models,a);c.delegateEvents(d),c.fetchOptions&&d.fetch(c.fetchOptions)})};e.prototype={events:{},fetchOptions:null,models:null,real:null,delegateEvents:function(a){_.each(this.events,function(b,c){a.on(c,b.method,b.context)},this),a.on("sync",this.onSync,this)},fetch:function(a){this.real&&this.real.fetch(a),this.fetchOptions=a},on:function(a,b,c){return this.real?this.real.on(a,b,c):void(this.events[a]={method:b,context:c})},set:function(a,b){this.real&&this.real.set(a,b),this.models=a},onSync:function(){this.length=this.real.length}},_.each(["create","each","find","get","map","off","remove","reset","toJSON"],function(a){e.prototype[a]=function(){return d.prototype[a].apply(this.real,arguments)}}),d.getInstance=function(a){var f;if(a&&a.collectionId&&a.collectionId in b)return f=b[a.collectionId],!f.url&&a.url&&(f.url=a.url),f;var g=_.extend({},a);if(!g.model){var h=_.chain(g).pick("idAttribute","defaults").mapObject(function(a,b){return"defaults"!==b||_.isObject(a)?a:tp.utils.decodeURLParam(a)}).value();g.model=_.isEmpty(h)?c:c.extend(h)}if(g.collectionType){var i=Nervenet.parseNamespace(g.collectionType);return i?new i(null,g):new e(g)}return f=new d(null,g),g.collectionId&&(b[g.collectionId]=f),f},d.destroyInstance=function(a){a in b&&delete b[a]}}(Nervenet.createNameSpace("tp.model")),function(a){var b=6e4,c=!1,d=tp.PROJECT+"-notice-cache",e=null;a.Notice=Backbone.Collection.extend({latest:0,url:tp.API+"notice/",initialize:function(){this.on("sync",this.syncHandler,this),this.fetch=_.bind(this.fetch,this)},fetch:function(a){c=!0;var e=localStorage.getItem(d);if(e){var f=JSON.parse(e);if(Date.now()-f.time<b)return this.set(f.notice),void this.trigger("sync");f.time=Date.now(),localStorage.setItem(d,JSON.stringify(f))}a=_.extend({data:{latest:this.latest},remove:!1},a),Backbone.Collection.prototype.fetch.call(this,a)},parse:function(a){return this.latest=_.reduce(a.list,function(a,b){return b.id>a?b.id:a},this.latest),e=a.list,a.list},stop:function(){c=!1,clearTimeout(b)},syncHandler:function(a){c&&setTimeout(this.fetch,b),a&&localStorage.setItem(d,JSON.stringify({notice:e,time:Date.now()}))}})}(Nervenet.createNameSpace("tp.model")),function(a){a.TableMemento=Backbone.Model.extend({waiting:!1,initialize:function(){this.key=tp.PROJECT+location.hash;var a=localStorage.getItem(this.key);a&&(a=JSON.parse(a),this.set(a,{silent:!0})),this.on("change",this.changeHandler,this)},_validate:function(a,b){return"validate"in b||(b.validate=!0),Backbone.Model.prototype._validate.call(this,a,b)},validate:function(a,b){return this.waiting||"ignore"in b&&!b.ignore?"表格正在更新数据，请稍候。":void 0},changeHandler:function(){localStorage.setItem(this.key,JSON.stringify(this.omit("page","keyword")))}})}(Nervenet.createNameSpace("tp.model")),function(a){a.DataSyncView=Backbone.View.extend({initialize:function(){this.submit=this.$("button.btn-primary")},displayProcessing:function(){this.$el.addClass("processing"),this.submit.spinner()},displayResult:function(a,b,c){b=(c?'<i class="fa fa-'+c+'"></i> ':"")+b,this.submit.spinner(!1),this.$el.removeClass("processing"),this.$(".alert-msg").hide().toggleClass("alert-danger",!a).toggleClass("alert-success",a).html(b+" ("+moment().format("HH:mm:ss")+")").slideDown()}})}(Nervenet.createNameSpace("tp.view")),function(a){a.Panel=tp.view.DataSyncView.extend({fragment:"",events:{"click input":"input_clickHandler","click .mark-all-button":"markAllButton_clickHandler","change [name=check]":"check_changeHandler",animationend:"animationEndHandler",webkitAnimationEnd:"animationEndHandler"},initialize:function(){this.template=Handlebars.compile(this.$("script").remove().html()),this.header=this.$(".dropdown-header"),this.button=this.$(".dropdown-toggle"),this.submit=this.$(".mark-all-button"),this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this),this.collection.on("remove",this.collection_removeHandler,this)},refreshNumber:function(){var a=this.$("input:not(:checked)").length;this.label&&this.label.remove(),0!==a&&(this.label=$("<span>"+(a>10?"10+":a)+"</span>").appendTo(this.button),this.button.find("i").addClass("animated swing"))},animationEndHandler:function(a){$(a.target).removeClass("animated swing")},check_changeHandler:function(a){var b=a.target.value;this.collection.get(b).destroy()},collection_addHandler:function(a){this.fragment+=this.template(a.toJSON())},collection_removeHandler:function(a){var b=this.$("#msg-"+a.id);this.refreshNumber(),setTimeout(function(){b.fadeOut(function(){$(this).remove()})},3e3)},collection_syncHandler:function(){this.fragment&&(this.header.after(this.fragment),this.refreshNumber(),this.fragment="")},input_clickHandler:function(a){a.stopPropagation()},markAll_errorHandler:function(a,b,c){this.displayResult(!1,b,"times")},markAll_successHandler:function(a){this.$(".alarm").remove(),this.label.remove(),this.displayResult(!0,a.msg,"check"),this.$(".alert").delay(3e3).slideUp()},markAllButton_clickHandler:function(a){var b=[];this.collection.each(function(a){b.push(a.id)}),this.collection.sync("delete",this,{url:this.collection.url+b.join(","),success:this.markAll_successHandler,error:this.markAll_errorHandler,context:this}),this.displayProcessing(),a.stopPropagation()}})}(Nervenet.createNameSpace("tp.notification")),function(a){a.Growl=Backbone.View.extend({count:0,fragment:[],initialize:function(){this.template=Handlebars.compile(this.$("script").remove().html()),this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this)},collection_addHandler:function(a){this.count<3&&this.fragment.push(this.template(a.toJSON())),this.count++},collection_syncHandler:function(){this.fragment.length&&(this.count>3&&(this.fragment[2]=this.template({number:this.count-2})),this.$el.html(this.fragment.join("")),this.fragment=[])}})}(Nervenet.createNameSpace("tp.notification")),function(a){function b(){this.permission="",this.requestPermission=function(){}}var c,d="Notification"in window?Notification:new b;"hidden"in document?c="hidden":"webkitHidden"in document?c="webkitHidden":"mozHidden"in document?c="mozHidden":"msHidden"in document&&(c="msHidden");var e=Backbone.View.extend({count:0,initialize:function(){if("granted"!==d.permission)try{d.requestPermission()}catch(a){}this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this)},createDesktopNotice:function(){if(document[c]&&"granted"===d.permission){var a=new d("点乐自助平台通知",{icon:"img/fav.png",body:"收到"+this.count+"条通知，请及时处理哟。"});a.onclick=function(){window.focus(),this.onclick=null}}},start:function(){tp.NOTICE_KEY&&this.collection.fetch()},stop:function(){this.collection.stop()},collection_addHandler:function(){this.count++},collection_syncHandler:function(){this.count>0&&(this.createDesktopNotice(this.count),this.count=0)}}),f=new tp.model.Notice;new a.Panel({el:".system-notice",collection:f}),new a.Growl({el:"#growl",collection:f}),a.Manager=new e({collection:f})}(Nervenet.createNameSpace("tp.notification")),function(a){function b(a,b){if(0!==b.length){b=_.isArray(b)?b:[b];var c=b.join("<br />");$(a).popover({trigger:"manual",title:"表单填写有误",content:c,html:!0}).popover("show").one("focus",function(){$(this).off(".popover").removeData("popover").siblings(".popover").remove().end().closest(".form-group").removeClass("error")}).closest(".form-group").addClass("error")}}var c="history-recorder",d=a.SmartForm=tp.view.DataSyncView.extend({$context:null,$router:null,uploaders:null,events:{"blur input,textarea":"input_blurHandler","focus input":"input_focusHandler",submit:"submitHandler",data:"dataHandler","click .collapsible legend":"legend_clickHandler"},initialize:function(){this.submit=this.getSubmit(),!this.model&&this.$el.data("target")&&(this.model=this.$context.getValue(this.$el.data("target"))),this.model instanceof Backbone.Model&&this.model.on("invalid",this.model_invalidHandler,this);var a=decodeURIComponent(this.$el.attr("action"));-1!=a.indexOf("{{API}}")&&(this.el.action=a.replace("{{API}}",tp.API)),this.initUploader()},remove:function(){this.model.off(null,null,this),_.each(this.uploaders,function(a){a.off("data"),a.remove&&a.remove()}),this.uploaders=null,Backbone.View.prototype.remove.call(this)},validate:function(){var a=this.el.elements;return this.$el.hasClass("uploading")?(alert("上传文件中，请稍候"),!1):"newpassword"in a&&a.newpassword.value!==a.repassword.value?(b(a.repassword,"两次密码不一致哟，麻烦检查下吧"),!1):"password"in a&&!/^[0-9a-zA-Z$!^#_@%&*.]{6,32}$/.test(a.password.value)?(b(a.password,"密码应为6~16个字符，请重新填写"),!1):!0},checkInput:function(a){if(a.prop("required")&&""===a.val())return"此项为必填项，您好像漏掉了哟";var b=a.attr("pattern");if(b&&""!==a.val()&&!new RegExp(b).test(a.val()))return"填写格式有误，麻烦您检查并重新填写";if(/number/i.test(a.attr("type"))&&(void 0!==a.attr("min")||void 0!==a.attr("max"))){var c=Number(a.val());if(isNaN(c))return"此项只能输入数字";if(void 0!==a.attr("min")&&c<a.attr("min")||void 0!==a.attr("max")&&c>a.attr("max"))return"数值超出规定范围"}return"password"!==a.attr("type")||/^[0-9a-zA-Z$!^#_@%&*.]{6,32}$/.test(a.val())?"":"密码应为6~16个字符，包含字母、数字、特殊符号等"},getSubmit:function(){var a="button:not([type=button]), input[type=submit]",b=this.$(a);if(0===b.length){var c=this.$el.attr("id");b=$(a).filter("[form="+c+"]")}return b},getValue:function(a){if(a.value)return a.value;var b=_.chain(a).filter(function(a){return a.checked}).map(function(a){return a.value}).value();return b.join(",")},initUploader:function(){var a=this,b=[];this.$(".uploader").each(function(){var c=$(this).data(),d=new meathill.SimpleUploader(this,c);d.on("start",a.uploader_startHandler,a),d.on("data",a.uploader_dataHandler,a),b.push(d)}),this.$(".fetcher").each(function(){var c=new tp.component.FileFetcher({el:this,model:a.model});c.on("start",a.uploader_startHandler,a),c.on("data",a.uploader_dataHandler,a),b.push(c)}),this.uploaders=b},useData:function(a){for(var b in a){if(!a.hasOwnProperty(b))return;"id"in a&&_.each(this.uploaders,function(b){b instanceof meathill.SimpleUploader&&(b.options.data=b.options.data||{},b.options.data.id=b.options.data.id||a.id)});var c=a[b];if(_.isArray(c))this.$('[name="'+b+'[]"]').each(function(){this.checked=-1!==c.indexOf(this.value)});else{var d=this.$("[name= "+b+"]:not([type=radio])").val(c);try{d.length>0||this.$("[name="+b+"][value="+c+'], [name="'+b+'[]"][value='+c+"]").prop("checked",!0)}catch(e){}"hidden"===d.attr("type")&&d.trigger("change")}}},input_blurHandler:function(a){var b=$(a.currentTarget),c=this.checkInput(b);c&&(this.$("input").tooltip("destroy"),b.tooltip({title:c,placement:"bottom",trigger:"manual"}).tooltip("show"))},input_focusHandler:function(a){$(a.currentTarget).tooltip("destroy")},legend_clickHandler:function(a){$(a.currentTarget).toggleClass("collapsed")},model_invalidHandler:function(a,b){this.displayResult(!1,b,"times"),this.trigger("error",null,1,{message:b})},submit_successHandler:function(a){this.displayResult(!0,a.msg,"smile-o"),this.$el.trigger("success",a),this.trigger("success",a)},submit_errorHandler:function(a,b,c){c=tp.Error.getAjaxMessage(a,b,c),this.displayResult(!1,c.message,c.icon),this.trigger("error",a,b,c)},uploader_dataHandler:function(a){this.$el.removeClass("uploading"),this.useData(a)},uploader_startHandler:function(){this.$el.addClass("uploading")},dataHandler:function(a,b){this.useData(b)},submitHandler:function(a){if(!this.$el.is(":hidden")){var b=this.el,c=b.action;if(this.$el.hasClass("fake")||this.$el.hasClass("loading"))return a.preventDefault(),!1;if(-1!==c.indexOf("#/")){c=c.substr(c.indexOf("#"));var d=this.getValue;return c=c.replace(/\/:([\w\[\]]+)/g,function(a,c){return"/"+d(b.elements[c])}),location.href=c,this.$el.trigger("success"),this.trigger("success"),a.preventDefault(),!1}this.displayProcessing();var e=this.validate();if(this.$el.hasClass("ajax")&&e){var f=this.$el.serialize();return tp.service.Manager.call(c,f,{success:this.submit_successHandler,error:this.submit_errorHandler,context:this,method:this.$el.attr("method")}),!1}if(this.$el.hasClass("model-editor")&&e){var g={},h=this;_.each(this.$el.serializeArray(),function(a){var b=a.name.replace("[]",""),c=""===a.value||isNaN(a.value)||/^0\d+$/.test(a.value)?a.value:Number(a.value);void 0!==g[b]?(_.isArray(g[b])||(g[b]=[g[b]]),g[b].push(c)):g[b]=c},this),this.$(".switch").each(function(){var a=!isNaN(parseInt(this.value)),b=a?Number(this.value):this.value,c=$(this).data("close");b=this.checked?b:c,g[this.name]=b});try{_.result(this.model,"url");this.model.save(g,{patch:!0,wait:!0,success:function(a,b){h.submit_successHandler(b)},error:function(a,b){h.submit_errorHandler(b)}})}catch(i){this.model.set(g)}return!1}return e}}});d.recordHistory=function(a,b){var d=document.getElementById(c).contentWindow.document;if(a.tagName&&"form"===a.tagName.toLowerCase())a=a.cloneNode(!0);else{var e=document.createElement("input");e.name=a,e.value=b,a=document.createElement("form"),a.action="about:blank",a.appendChild(e)}d.body.appendChild(a),a.onsubmit=null,a.submit(),d.body.innerHTML=""},$(document).on("change","[type=range]",function(a){$(a.target).next().html(a.target.value)}).on("change dp.change",".auto-submit",function(a){if("dp"===a.type){var b=$(a.target);if(!b.hasClass("ready"))return void b.addClass("ready")}$(a.target).closest("form").submit()}).on("change",".check-all",function(a){var b=a.target,c=b.value,d=b.checked;$('[name="'+c+'"]').prop("checked",d)}).on("click change","[data-toggle-class]",function(a){var b=$(a.currentTarget),c=b.data(),d=c.target,e=c.toggleClass,f=c.group,g=Array.prototype.join,h=g.call($('[data-toggle-class][data-group="'+f+'"]').map(function(){return this.dataset.toggleClass})," ");$(d).removeClass(h).addClass(e)})}(Nervenet.createNameSpace("tp.component")),function(a){a.BaseList=Backbone.View.extend({autoFetch:!0,fragment:"",initialize:function(a){this.template=Handlebars.compile(this.$("script").remove().html().replace(/\s{2,}|\n/g,"")),this.container=a.container?this.$(a.container):this.$el,this.collection=this.getCollection(a),this.collection.on("add",this.collection_addHandler,this),this.collection.on("change",this.collection_changeHandler,this),this.collection.on("remove",this.collection_removeHandler,this),this.collection.on("sync",this.collection_syncHandler,this),this.collection.on("reset",this.collection_resetHandler,this),(a.autoFetch||!("autoFetch"in a)&&this.autoFetch)&&this.refresh(a)},remove:function(){this.collection.off(null,null,this),Backbone.View.prototype.remove.call(this)},render:function(){this.$(".waiting").hide(),this.container.append(this.fragment),this.fragment="",this.$el.removeClass("loading")},getCollection:function(a){if(this.collection)return this.collection;var b=this.$el.data();return"url"in b&&(b.url=b.url.replace("{{API}}",tp.API)),a=_.extend(a,b),this.params=tp.utils.decodeURLParam(a.params),(a.start||a.end)&&(a.defaults=_.pick(a,"start","end")),tp.model.ListCollection.getInstance(a)},refresh:function(a){a=a||{},a.data=_.extend(a.data,this.params),this.collection.fetch(a)},collection_addHandler:function(a,b,c){if(this.fragment+=this.template(a instanceof Backbone.Model?a.toJSON():a),c&&c.immediately){var d=$(this.fragment);return d.attr("id",a.id||a.cid),this.container[c.prepend?"prepend":"append"](d),this.fragment="",d}},collection_changeHandler:function(a){var b=this.template(a.toJSON());$(document.getElementById(a.id||a.cid)).replaceWith(b)},collection_removeHandler:function(a,b,c){var d=$(document.getElementById(a.id||a.cid));c.fadeOut?d.fadeOut(function(){$(this).remove()}):d.remove()},collection_resetHandler:function(){this.container.empty(),this.collection.each(function(a){this.collection_addHandler(a)},this),this.render()},collection_syncHandler:function(){this.render()}})}(Nervenet.createNameSpace("tp.component")),function(a){a.FileFetcher=Backbone.View.extend({events:{"click .fetch-button":"fetchButton_clickHandler","change [name]":"input_changeHandler"},validate:function(a){var b=/^https?:\/\//;return b.test(a)},fetchButton_clickHandler:function(){var a=this.$("[name=ad_url]"),b=a.val();if(b&&"hidden"!==a.attr("type")){if(/itunes\.apple\.com/.test(b))return void alert("App Store应用暂时不支持抓取");tp.service.Manager.call(tp.API+"fetch/",{type:"ad_url",id:this.model.id,file:b},{context:this,success:this.fetchFile_successHandler,error:this.fetchFile_errorHandler}),this.$(".fetch-button").prop("disabled",!0).find("i").addClass("fa-spin fa-spinner"),this.$("[name=ad_url]").prop("disabled",!0)}},fetchFile_successHandler:function(a){alert("服务器抓取文件成功"),this.trigger("data",a.form),this.$(".fetch-button").prop("disabled",!1).find("i").removeClass("fa-spin fa-spinner"),this.$("[name=ad_url]").prop("disabled",!1)},fetchFile_errorHandler:function(a){alert(a.msg)},input_changeHandler:function(a){a.target.value=a.target.value.replace(/\s/g,"");var b=this.validate(a.target.value);this.$(".fetch-button").toggleClass("btn-warning",b).prop("disabled",!b)}})}(Nervenet.createNameSpace("tp.component")),function(a){a.Pager=Backbone.View.extend({events:{"click a":"clickHandler"},initialize:function(a){this.template=this.$("script").remove().html()||"",this.template=this.template?Handlebars.compile(this.template):!1,this.pagesize=this.collection.pagesize,this.total=Math.ceil(a.length/this.pagesize),this.render(),this.displayPageNum(),this.collection.on("sync",this.collection_syncHandler,this)},remove:function(){this.collection.off(null,null,this),this.model=this.collection=null,Backbone.View.prototype.remove.call(this)},render:function(){if(this.template){for(var a=this.model.get("page"),b=[],c=a-5>0?a-5:0,d=c+10<this.total?c+10:this.total,e=d-c,f=0;e>f;f++)b[f]={index:f+c,label:f+c+1};this.$el.html(this.template({pages:b,prev:a-1,next:a+1}))}},displayPageNum:function(){var a=this.model.get("page")||0,b=this.total;this.$('[href="#/to/'+a+'"]').closest(".hidden-xs").addClass("active").siblings().removeClass("active"),this.$el.each(function(){$(this).children().first().toggleClass("disabled",0===a).end().last().toggleClass("disabled",a>=b-1)})},setTotal:function(a,b){this.pagesize=b||this.pagesize,this.total=Math.ceil(a/this.pagesize),this.render(),this.displayPageNum()},collection_syncHandler:function(){this.setTotal(this.collection.total,this.collection.pagesize)},clickHandler:function(a){var b=$(a.currentTarget),c=b.parent();if(c.hasClass("disabled")||c.hasClass("active"))return!1;var d=b.attr("href"),e=Number(d.substr(d.lastIndexOf("/")+1));this.model.set("page",e),b.html(tp.component.spinner),this.$el.children().addClass("disabled"),a.preventDefault()}}),a.Search=Backbone.View.extend({events:{keydown:"keydownHandler"},initialize:function(){this.model.get("keyword")&&this.$el.val(this.model.get("keyword")),this.el.value&&this.model.set("keyword",this.el.value),this.model.on("change:keyword",this.model_changeHandler,this),this.collection.on("sync",this.collection_syncHandler,this)},remove:function(){this.model.off(null,null,this),this.collection.off(null,null,this),this.collection=this.model=null,Backbone.View.prototype.remove.call(this)},collection_syncHandler:function(){this.$el.prop("readonly",!1),this.spinner&&this.spinner.remove()},model_changeHandler:function(a,b){this.el.value=b},keydownHandler:function(a){13===a.keyCode&&(this.model.unset("keyword",{silent:!0}),this.model.set({
keyword:a.target.value,page:0}),this.$el.prop("readonly",!0),this.spinner=this.spinner||$(tp.component.spinner),this.spinner.insertAfter(this.$el),a.preventDefault())}}),a.Filter=Backbone.View.extend({events:{change:"changeHandler"},initialize:function(){this.model.on("change",this.model_changeHandler,this),this.collection.on("sync",this.collection_syncHandler,this),this.render()},render:function(){var a=this.model.toJSON();for(var b in a)this.$("[name="+b+"]").val(a[b])},remove:function(){this.collection.off(null,null,this),this.collection=this.model=null,Backbone.View.prototype.remove.call(this)},collection_syncHandler:function(){this.$(".fa-spin").remove(),this.$("select").prop("disabled",!1);var a=this.collection.options;a&&this.$("select").each(function(){var b=$(this),c=b.data("options");if(!(c in a)||b.hasClass("ready"))return!0;var d=b.find("script").html(),e=b.find(".fixed");d=Handlebars.compile(d),b.addClass("ready").html(d(a)).prepend(e)})},model_changeHandler:function(){this.$("select").prop("disabled",!0)},changeHandler:function(a){var b=a.target,c=b.name,d=b.value;c&&(d?this.model.set(c,d,{reset:!0}):this.model.unset(c,{reset:!0}),$(b).after(tp.component.spinner))}}),a.FixedHeader=Backbone.View.extend({className:"fixed-table-header",tagName:"div",visible:!1,events:{"click .filter,.order":"button_clickHandler"},initialize:function(a){this.target=a.target,this.target.on("table-rendered",this.render,this),this.top=this.target.$el.offset().top,this.scrollHandler=_.bind(this.scrollHandler,this),$(window).scroll(this.scrollHandler),this.$el.appendTo("body")},remove:function(){this.target=null,$(window).off("scroll",this.scrollHandler),Backbone.View.prototype.remove.call(this)},render:function(){var a=this.target.$el.clone(),b=a.find("th");a.find("tbody, tfoot").remove(),this.target.$("th").each(function(a){b[a].width=this.offsetWidth}),this.$el.html(a)},button_clickHandler:function(a){var b=-1!=a.target.className.indexOf("filter")?"filter":"order";this.target.$("thead ."+b+'[href="'+a.target.hash+'"]').click(),a.preventDefault()},scrollHandler:function(){var a=document.body.scrollTop+70;a>this.top?this.visible||(this.visible=!0,this.$el.show()):(this.$el.hide(),this.visible=!1)}})}(Nervenet.createNameSpace("tp.component.table")),function(a){a.CollectionSelect=a.BaseList.extend({autoFetch:!0,refresh:function(b){this.collection.length?this.collection_resetHandler():a.BaseList.prototype.refresh.call(this,b)},collection_addHandler:function(b,c,d){var e=a.BaseList.prototype.collection_addHandler.call(this,b,c,d);e&&e.prop("selected",!0).siblings().prop("selected",!1)},collection_changeHandler:function(a){this.$("[value="+a.id+"]").prop("selected",!0).siblings().prop("selected",!1)}})}(Nervenet.createNameSpace("tp.component")),function(a){a.DateRanger=Backbone.View.extend({events:{"click .shortcut":"shortcut_clickHandler","click .range input":"input_clickHandler","click .range button":"range_clickHandler"},initialize:function(){this.$("[type=date]").datetimepicker({format:moment.DATE_FORMAT}),this.template=Handlebars.compile(this.$("script").html());var a=new Date,b=a.getMonth(),c=_.map(_.range(b,b-3,-1),function(b){return{month:b,start:moment(new Date(a.getFullYear(),b-1,1)).format(moment.DATE_FORMAT),end:moment(new Date(a.getFullYear(),b,0)).format(moment.DATE_FORMAT)}}),d=this;this.$("script").replaceWith(this.template({months:c})),this.$(".this-month").data("start",moment().startOf("month").format(moment.DATE_FORMAT)),this.$(".this-season").data("start",moment().startOf("quarter").format(moment.DATE_FORMAT)),this.$(".shortcut").each(function(){var a=$(this).data();a.start=d.formatDate(a.start),a.end=d.formatDate(a.end),$(this).data(a).attr("data-start",a.start).attr("data-end",a.end)})},render:function(a){var b=_.defaults(a,{start:-31,end:0});isNaN(b.start)||(b.start=moment().add(b.start,"days").format(moment.DATE_FORMAT)),isNaN(b.end)||(b.end=moment().add(b.end,"days").format(moment.DATE_FORMAT)),this.$("[name=start]").val(b.start),this.$("[name=end]").val(b.end);var c=this.$('[data-start="'+b.start+'"][data-end="'+b.end+'"]');return this.$(".label").text(c.length?c.text():b.start+" ~ "+b.end),b},trigger:function(a,b){b=b||{},b.reset=!0,this.model.set(a,b)},formatDate:function(a){return isNaN(a)?a:moment().add(a,"days").format(moment.DATE_FORMAT)},use:function(a){this.model=a;var b=this.render(a.pick("start","end"));this.model.set(b,{silent:!0})},input_clickHandler:function(a){a.stopPropagation()},range_clickHandler:function(){var a=this.$("[name=start]").val(),b=this.$("[name=end]").val();this.$(".shortcut").removeClass("active"),this.$(".label").text(a+" - "+b),this.trigger({start:a,end:b})},shortcut_clickHandler:function(a){var b=$(a.currentTarget),c=b.data("start"),d=b.data("end");b.addClass("active").siblings().removeClass("active"),this.$(".label").text(b.text());var e=this.render({start:c,end:d});this.trigger(e),a.preventDefault()}})}(Nervenet.createNameSpace("tp.component")),function(a){a.Manager={$context:null,$me:null,map:{".base-list":"tp.component.BaseList",".smart-table":"tp.component.SmartTable",".add-on-list":"tp.component.AddOnList",".collection-select":"tp.component.CollectionSelect",".morris-chart":"tp.component.MorrisChart",".typeahead":"tp.component.Typeahead",form:"tp.component.SmartForm"},components:[],check:function(a){var b=[];a.data("components",b);var c=a.find(".datetimepicker");c.length&&c.each(function(){var a=$(this).data();a=_.mapObject(a,function(a,b){switch(b){case"maxDate":case"minDate":case"defaultDate":return moment().add(a,"days");default:return a}}),$(this).datetimepicker(a)});var d=this;for(var e in this.map)if(this.map.hasOwnProperty(e)){var f=a.find(e);if(f.length){var g=Nervenet.parseNamespace(this.map[e]);g?f.each(function(){b.push(d.$context.createInstance(g,{el:this}))}):this.loadMediatorClass(b,this.map[e],f)}}a.find("[data-mediator-class]").each(function(){var a=$(this).data("mediator-class"),c=Nervenet.parseNamespace(a);c?b.push(d.$context.createInstance(c,{el:this})):d.loadMediatorClass(b,a,$(this))})},clear:function(a){var b=a.find(".datetimepicker");b.destroy&&b.destroy();var c=a.data("components");if(c&&0!==c.length){for(var d=0,e=c.length;e>d;d++)c[d].remove();c.length=0}},find:function(a,b){var c=a.data("components");if(c){var d=[];b=Nervenet.parseNamespace(b);for(var e=0,f=c.length;f>e;e++)c[e]instanceof b&&d.push(c[e]);return d}},getPath:function(a){var b=a.split(".");return b[0]===tp.NAME_SPACE&&(b=b.slice(1)),"js/"+b.join("/")+".js"},loadMediatorClass:function(a,b,c,d){var e=this,f=document.createElement("script");f.async=!0,f.src=this.getPath(b),f.onload=function(){this.onload=null;var f=Nervenet.parseNamespace(b);if(!f)throw new Error("cannot find mediator");c&&c.each(function(){a.push(e.$context.createInstance(f,{el:this}))}),d&&d(a)},document.head.appendChild(f)},preCheck:function(a){var b=a.data("components");if(!b)return!0;for(var c=0,d=b.length;d>c;c++)if("preCheck"in b[c]&&!b[c].preCheck())return!1;return!0},createComponents:function(){for(var a=0,b=this.components.length;b>a;a++){var c=this.components[a][0],d=this.components[a][1];c=_.bind(c,this,d),c()}},registerComponent:function(a,b){this.components.push([a,b])}},a.spinner='<i class="fa fa-spin fa-spinner"></i>'}(Nervenet.createNameSpace("tp.component")),function(a){var b,c='<p><i class="fa fa-spinner fa-spin fa-4x"></i></p>';a.Base=tp.view.DataSyncView.extend({$context:null,events:{"shown.bs.modal":"shownHandler","hidden.bs.modal":"hiddenHandler","loaded.bs.modal":"loadCompleteHandler","click .modal-footer .btn-primary":"submitButton_clickHandler","click [data-dismiss=modal]":"closeButton_clickHandler",keydown:"keydownHandler",success:"form_successHandler"},initialize:function(a){this.model=this.model||this.$context.getValue("model"),a.isRemote?(this.$el.addClass("loading").find(".modal-body").html(c),/\.hbs$/.test(a.content)?$.get(a.content,_.bind(this.template_loadedHandler,this)):(a.isMD=/\.md$/.test(a.content),$.get(a.content,_.bind(this.onLoadComplete,this))),ga("send","pageview",a.content)):this.onLoadComplete(a.content),this.options=a,this.$el.modal(a)},remove:function(){clearTimeout(b),this.options=null,this.off(),Backbone.View.prototype.remove.call(this)},hide:function(a){a=void 0===a?3e3:a;var c=this.$el;b=setTimeout(function(){c.modal("hide")},a)},onLoadComplete:function(a){a&&(this.options&&this.options.isMD&&(a=marked(a)),this.$(".modal-body").html(a)),this.$el.removeClass("loading").find(".modal-footer .btn-primary").prop("disabled",!1),tp.component.Manager.check(this.$el,this.model)},closeButton_clickHandler:function(){this.$el.modal("hide"),this.trigger("cancel",this)},form_successHandler:function(a){this.hide(a),this.trigger("success")},submitButton_clickHandler:function(a){a.currentTarget.form||this.$el.modal("hide"),this.trigger("confirm",this)},template_loadedHandler:function(a){this.template=Handlebars.compile(a);var b=_.extend({API:tp.API},this.options,this.model?this.model.toJSON():null);this.onLoadComplete(this.template(b))},hiddenHandler:function(){this.remove(),this.trigger("hidden",this)},keydownHandler:function(a){13===a.keyCode&&a.ctrlKey&&(this.$(".modal-footer .btn-primary").submit(),a.preventDefault())},loadCompleteHandler:function(){this.onLoadComplete()},shownHandler:function(){this.$(".modal-footer .btn-primary").prop("disabled",!1)}})}(Nervenet.createNameSpace("tp.popup")),function(a){var b,c=a.Editor=tp.view.DataSyncView.extend({$context:null,form:null,events:{"hidden.bs.modal":"hiddenHandler",keydown:"keydownHandler","mousedown .input-group":"inputGroup_mouseDownHandler"},initialize:function(a){this.submit=this.$(".btn-primary"),this.options=a;var b=a.type||"short-text",c=a.template?"page/"+a.template:tp.path+"template/popup-"+b;$.get(c+".hbs",_.bind(this.loadCompleteHandler,this),"html");var d=$(".editor-info");d.length&&(d=Handlebars.compile(d.html()),this.$(".info").html(d(this.model.toJSON()))),this.$el.modal(a)},render:function(a){a=Handlebars.compile(a),this.$(".loading").remove(),this.form=new tp.component.SmartForm({tagName:"form",id:"prop-editor",className:"editor-form model-editor",model:this.model});var b=a(_.extend(this.model.toJSON(),this.options));this.form.$el.html(b).insertAfter(this.$(".alert-msg")),this.form.on("success",this.form_successHandler,this),this.form.on("error",this.form_errorHandler,this),b=this.$("script").remove().html(),b&&(this.template=Handlebars.compile(b),this.$("script").empty());var c=this.$(".datetimepicker");c.length&&c.each(function(){$(this).datetimepicker($(this).data())}),this.options.hasComponents&&tp.component.Manager.check(this.form.$el),this.submit.prop("disabled",!1)},hide:function(a){a=void 0===a?3e3:a;var c=this.$el;b=setTimeout(function(){c.modal("hide")},a)},form_errorHandler:function(a,b,c){this.displayResult(!1,c.message,"frown-o"),this.trigger("error",a,b,c)},form_successHandler:function(a){this.displayResult(!0,a.msg,"smile-o"),this.trigger("success",a),this.hide()},inputGroup_mouseDownHandler:function(a){$(a.currentTarget).find("[type=radio]").prop("checked",!0)},keydownHandler:function(a){13===a.keyCode&&a.ctrlKey&&(this.form.$el.submit(),a.preventDefault())},loadCompleteHandler:function(a){this.render(a)},hiddenHandler:function(){this.form.remove(),this.collection&&this.collection instanceof Backbone.Collection&&this.collection.off(null,null,this),clearTimeout(b),this.remove(),this.trigger("hidden")}});a.SearchEditor=c.extend({fragment:"",events:_.extend(c.prototype.events,{"click .search-button":"searchButton_clickHandler"}),initialize:function(a){c.prototype.initialize.call(this,a),this.collection=tp.model.ListCollection.getInstance(),this.collection.url=tp.API+a.url,this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this)},remove:function(){this.collection.off(),Backbone.View.prototype.remove.call(this)},render:function(a){c.prototype.render.call(this,a)},search:function(){var a=this.$("[type=search]").val();a&&(this.collection.fetch({data:{keyword:a}}),this.$("[type=search]").prop("disabled",!0),this.$(".search-button").spinner())},collection_addHandler:function(a){this.fragment+=this.template(_.extend(a.toJSON(),this.options))},collection_syncHandler:function(){this.fragment=this.fragment||"没有与此关键词接近的结果。",this.$(".search-result").html(this.fragment),this.$("[type=search]").prop("disabled",!1),this.$(".search-button").spinner(!1),this.fragment=""},searchButton_clickHandler:function(){this.search()},keydownHandler:function(a){c.prototype.keydownHandler.call(this,a),13===a.keyCode&&"search"===a.target.type&&""!=a.target.value&&(this.search(),a.preventDefault())}}),a.TagsEditor=c.extend({events:_.extend(c.prototype.events,{"click .add-button":"addButton_clickHandler"}),initialize:function(a){c.prototype.initialize.call(this,a),this.collection.on("add",this.collection_addHandler,this)},render:function(a){if(c.prototype.render.call(this,a),this.options.tag&&this.collection){var b=this.options.tag;this.collection.map(function(a){a.set("tag",a.get(b))})}this.$(".tags").html(this.template({value:this.collection.toJSON()}))},add:function(){var a=this.$("[name=query]").val().replace(/^\s+|\s+$/,"");a&&!this.collection.find({tag:a})&&(this.$("[name=query], .add-button").prop("disabled",!0),this.$(".add-button i").addClass("fa-spin fa-spinner"),this.collection.create({tag:a},{wait:!0}))},addButton_clickHandler:function(){this.add()},collection_addHandler:function(a){var b=a.toJSON();b.index=this.collection.length-1,$(this.template({value:[b],append:!0})).insertBefore(this.$("hr")),this.$("[name=query],.add-button").prop("disabled",!1).val(""),this.$(".add-button i").removeClass("fa-spin fa-spinner")},keydownHandler:function(a){13===a.keyCode&&""!=a.target.value&&(this.add(),a.preventDefault())}}),a.SelectEditor=c.extend({render:function(a){if(this.options.options&&(this.model.options?this.options.options=this.model.options[this.options.options]:this.model.collection.options&&(this.options.options=this.model.collection.options[this.options.options])),c.prototype.render.call(this,a),this.options.addNew){var b=new tp.model.ListCollection.getInstance({collectionId:this.options.prop,url:tp.API+this.options.url});new tp.component.CollectionSelect({el:this.$("select"),collection:b});b.reset(this.options.options)}else this.options.list&&this.$("select").html($(this.options.list).html());this.$("select").val(this.options.value)}}),a.NumberEditor=c.extend({initialize:function(a){a.range="range"===a.type,a.type="number",c.prototype.initialize.call(this,a)}}),a.FileEditor=c.extend({events:_.extend({"click [data-dismiss]":"clickHandler"},c.prototype.events),initialize:function(a){a.isImage=/image\/\*/.test(a.accept),a.API=tp.API,a.multiple&&(a.items=_.isArray(a.value)?a.value:a.value.split(",")),a.backdrop="static",a.keyboard=!1,c.prototype.initialize.call(this,a)},render:function(a){c.prototype.render.call(this,a),this.form.initUploader()},clickHandler:function(a){var b="您有文件正在上传，关闭窗口将导致上传失败。您确认要继续关闭窗口么？";this.form.$el.hasClass("loading")&&!confirm(b)&&a.stopPropagation()}}),a.SwitchEditor=c.extend({initialize:function(a){var b={open:1,close:0,readonly:!0};a=_.extend(b,a),a.value=this.model.get(a.prop)!=a.open,c.prototype.initialize.call(this,a)}}),a.CheckboxEditor=c.extend({render:function(a){this.options.options&&(this.model.options?this.options.options=this.model.options[this.options.options]:this.options.options=this.model.collection.options[this.options.options]),c.prototype.render.call(this,a)}}),a.DateTimeEditor=c.extend({initialize:function(a){a.format=moment[a.type.toUpperCase()+"_FORMAT"],a.realType=a.type,a.type="datetime",c.prototype.initialize.call(this,a)}})}(Nervenet.createNameSpace("tp.popup")),function(a){a.Loader=Backbone.View.extend({$context:null,fresh:!1,tagName:"div",events:{"click .edit":"edit_clickHandler"},initialize:function(a){this.model instanceof Backbone.Model&&!a.hasData?(this.model.once("sync",this.model_syncHandler,this),this.model.fetch(a)):this.isModelReady=!0,$.get(a.template,_.bind(this.template_getHandler,this),"html"),"refresh"in a&&(this.refresh=a.refresh)},render:function(){this.$el.html(this.template(this.model instanceof Backbone.Model?this.model.toJSON():this.model)),this.refresh&&(this.refresh=!1,this.model.on("change",this.model_changeHandler,this));var a=this,b=this.$el,c=this.model;setTimeout(function(){tp.component.Manager.check(b,c),a.trigger("complete")},0)},edit_clickHandler:function(a){var b=$(a.currentTarget),c=b.data(),d=a.currentTarget.hash.substr(1);c.label=c.label||b.closest("td").prev("th").text(),this.$context.trigger("edit-model",this.model,d,c),a.preventDefault()},model_changeHandler:function(){var a=this.$(".active").filter(".tab-pane").attr("id");tp.component.Manager.clear(this.$el),this.render(),a&&this.$("[href=#"+a+"][data-toggle]").click()},model_syncHandler:function(){return this.template?this.render():void(this.isModelReady=!0)},template_getHandler:function(a){this.template=Handlebars.compile(a),this.isModelReady&&this.render()}})}(Nervenet.createNameSpace("tp.view")),function(a){var b='<link rel="stylesheet" href="{{url}}css/screen.css"><link rel="stylesheet" href="{{url}}css/print.css"><title>{{title}}</title>';a.Body=Backbone.View.extend({$context:null,$sidebarEditor:null,events:{"click .add-button":"addButton_clickHandler","click .print-button":"printButton_clickHandler","click .refresh-button":"refreshButton_clickHandler","click .request-button":"requestButton_clickHandler"},initialize:function(){this.framework=this.$(".framework"),this.container=this.$("#page-container"),this.loading=this.$("#page-loading").remove().removeClass("hide"),this.loadCompleteHandler=_.bind(this.loadCompleteHandler,this),this.$el.popover({selector:"[data-toggle=popover]"}).tooltip({selector:"[data-toggle=tooltip]"})},clear:function(){this.$context.removeValue("model"),tp.component.Manager.clear(this.container),this.page&&(this.page.remove(),this.page=null)},createSidebar:function(){this.$sidebarEditor.render()},load:function(a,b,c){if(c=c||{},this.clear(),this.$el.toggleClass("full-page",!!c.isFull).removeClass(this.lastClass),$("#navbar-side").removeClass("in"),/.hbs$/.test(a)){var d=c.loader||tp.view.Loader,e=this.page=this.$context.createInstance(d,_.extend({template:a,model:b},c));this.container.html(e.$el),e.once("complete",this.page_loadCompleteHandler,this)}else/.md$/.test(a)?tp.service.Manager.get(a,this.md_loadCompleteHandler,this):this.container.load(a,this.loadCompleteHandler);return this.container.append(this.loading),this.trigger("load:start",a),ga("send","pageview",a),this},setFramework:function(a,b,c,d){return this.$el.addClass(a),this.lastClass=a,d instanceof Backbone.Model&&b?(d.once("sync",function(){this.setTitle(b,c,d)},this),this):this.setTitle(b,c,d)},setTitle:function(a,b,c){return c&&(c=c instanceof Backbone.Model?c.toJSON():c,a=Handlebars.compile(a)(c),b=Handlebars.compile(b)(c)),a+=b?" <small>"+b+"</small>":"",this.$("#content > .page-header > h1").html(a),this},start:function(a){this.isStart=!0,this.$("#page-preloader").remove(),a&&(this.createSidebar(),this.$el.removeClass("full-page").find(".login").remove(),this.$el.toggleClass("cp",this.model.isCP()),tp.component.Manager.createComponents())},addButton_clickHandler:function(a){var b=$(a.currentTarget).data();!b.title&&a.currentTarget.title&&(b.title=a.currentTarget.title),b.collectionId=a.currentTarget.hash.substr(1),this.$context.trigger("add-model",b),a.preventDefault()},md_loadCompleteHandler:function(a){this.container.html(marked(a)),this.loading.remove(),this.trigger("load:complete")},refreshButton_clickHandler:function(a){Backbone.history.loadUrl(Backbone.history.fragment),a.preventDefault()},requestButton_clickHandler:function(a){var b=a.target.getAttribute("href");b=/https?:\/\//.test(b)?b:tp.API+b,$.get(b,function(a){0===a.code&&alert(a.msg)},"json"),a.preventDefault()},page_loadCompleteHandler:function(){this.loading.remove()},printButton_clickHandler:function(a){var c=a.currentTarget,d=c.getAttribute("href"),e=c.title,f=window.open("","print-window"),g=location.href,h=Handlebars.compile(b);g=g.substr(0,g.lastIndexOf("/")+1),f.document.body.innerHTML=$(d).html(),f.document.head.innerHTML=h({title:e,url:g}),f.print()},loadCompleteHandler:function(a,b){"error"===b?this.trigger("load:failed"):tp.component.Manager.check(this.container),this.loading.remove(),this.trigger("load:complete")}})}(Nervenet.createNameSpace("tp.view")),function(a){a.Me=Backbone.View.extend({initialize:function(){this.template=Handlebars.compile(this.$("script").html()),this.model.on("change",this.model_changeHandler,this)},render:function(){"fullname"in this.model.changed&&this.$(".username").text(this.model.get("fullname")),this.$el.filter(".navbar-user").html(this.template(this.model.toJSON()))},model_changeHandler:function(){this.render()}})}(Nervenet.createNameSpace("tp.view")),function(a){var b=tp.PROJECT+"-hidden-items";a.SidebarEditor=Backbone.View.extend({events:{"click .eye-edit-button":"eyeEditButton_clickHandler","click .accordion-toggle":"accordionToggle_clickHandler","click #menu-edit-button":"menuEditButton_clickHandler","click #edit-confirm-button":"editConfirmButton_clickHandler","click #edit-cancel-button":"editCancelButton_clickHandler","click #menu-search-button":"menuSearchButton_clickHandler","click #search-clear-button":"searchClearButton_clickHandler","click #menu-collapse-button":"menuCollapseButton_clickHandler","blur #menu-search-input":"menuSearchInput_blurHandler","keyup #menu-search-input":"menuSearchInput_keyupHandler"},initialize:function(){this.hiddenItems=JSON.parse(localStorage.getItem(b))||[],this.template=Handlebars.compile(this.$("#navbar-side-inner").find("script").remove().html())},render:function(){this.$(".sidebar-nav-item").remove();var a=this.model.get("sidebar")?this.model.get("sidebar"):"default";$.getJSON("page/sidebar/"+a+".json",_.bind(function(a){_.each(a,function(a){var b=a.link||a["sub-id"];a.invisible=-1!==this.hiddenItems.indexOf("parent-"+b),a.sub&&_.each(a.sub,function(a){a.invisible=-1!==this.hiddenItems.indexOf(a.link)},this)},this);var b=this.template({list:a});this.$("#navbar-side-inner").append(b)},this))},eyeEditButton_clickHandler:function(a){var b=$(a.currentTarget).closest("li");b.toggleClass("hidden"),a.preventDefault(),a.stopPropagation()},menuEditButton_clickHandler:function(){this.$el.addClass("sidebar-editing"),this.$(".collapse").collapse("show")},editConfirmButton_clickHandler:function(){var a=_.map(this.$(".hidden"),function(a){return a.id});this.$el.removeClass("sidebar-editing"),this.hiddenItems=a,localStorage.setItem(b,JSON.stringify(a))},editCancelButton_clickHandler:function(){this.$el.removeClass("sidebar-editing"),this.$(".collapse").collapse("hide"),this.render()},menuSearchButton_clickHandler:function(){this.$el.addClass("sidebar-search"),this.$(".collapse").collapse("show"),this.$("#menu-search-input").focus()},menuSearchInput_blurHandler:function(a){a.target.value.trim()||(this.$el.removeClass("sidebar-search"),this.$("#navbar-side-inner").removeClass("search-typing"))},searchClearButton_clickHandler:function(){this.$("#menu-search-input").val("").focus()},menuSearchInput_keyupHandler:function(a){var b=this,c=a.target.value.trim();this.$("#navbar-side-inner").addClass("search-typing"),c&&(clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(function(){var a=".*"+c.split("").join(".*")+".*",d=new RegExp(a);b.$('a[href^="#/"]').each(function(){var a=d.test(this.innerText.toLowerCase());$(this).closest("li").toggleClass("mismatch",!a)})},500))},menuCollapseButton_clickHandler:function(){$("body").toggleClass("sidebar-collapsed")},accordionToggle_clickHandler:function(a){$("body").hasClass("sidebar-collapsed")&&(this.$(".accordion-toggle").each(function(){var b=$(this).siblings("ul");this===a.currentTarget?b.toggleClass("view").height("auto"):b.removeClass("view")}),a.preventDefault(),a.stopPropagation())}})}(Nervenet.createNameSpace("tp.view")),function(a){a.Dashboard=a.Loader.extend({className:"dashboard",render:function(){a.Loader.prototype.render.call(this),this.$el.removeClass("loading"),this.$(".fa").remove("fa-spin fa-spinner")},model_changeHandler:function(a){var b=_.pick(a.changed,"start","end");_.isEmpty(b)?this.render():(a.fetch({data:a.pick("start","end")}),this.$el.addClass("loading"),this.$(".fa").addClass("fa-spin fa-spinner"))}})}(Nervenet.createNameSpace("tp.view")),function(a){a.AddOnList=a.BaseList.extend({autoFetch:!1,initialize:function(b){b=_.extend({container:"tbody"},b),this.collection=new Backbone.Collection,a.BaseList.prototype.initialize.call(this,b);var c=this.$el.data("collection-id"),d=this.$el.data("key"),e=tp.model.ListCollection.getInstance({collectionId:c});e.on("data:"+d,this.collection_dataHandler,this)},collection_dataHandler:function(a){this.collection.reset(a)}})}(Nervenet.createNameSpace("tp.component")),function(a){a.LoginForm=Backbone.View.extend({events:{"click #verify-code":"verifyCode_clickHandler"},verifyCode_clickHandler:function(a){var b=a.target.src,c=b.indexOf("?ts="),d=Date.now();b=-1===c?b+"?ts="+d:b.replace(/\?ts=\d+$/,"?ts="+d),a.target.src=b}})}(Nervenet.createNameSpace("tp.component")),function(a){a.MorrisChart=Backbone.View.extend({$colors:null,src:{},initialize:function(a){if(a.data)return this.createOptions(a),void this.render();var b=this.$el.data();if(a=_.extend({autoFetch:!0},a,b),a.url)return this.collection=tp.model.ListCollection.getInstance(a),this.createOptions(a),void(a.autoFetch?(this.collection.on("sync reset",this.collection_fetchHandler,this),this.collection.fetch()):this.collection_fetchHandler());var c=this.$("script");if(c.length){var d=JSON.parse(c.remove().html().replace(/,\s?]/,"]"));if(d.data.length)return this.createOptions(a,d),void this.render()}this.showEmpty()},remove:function(){this.collection&&this.collection.off(null,null,this),Backbone.View.prototype.remove.call(this)},render:function(){this.$el.empty(),this.chart=new Morris[this.className](this.options)},createOptions:function(a,b){a=_.extend({element:this.el,lineWidth:2},a,b),this.className="type"in a?a.type.charAt(0).toUpperCase()+a.type.substr(1):"Line","colors"in a?a.colors=a.lineColors=a.barColors=_.isArray(a.colors)?a.colors:a.colors.split(","):a.colors=a.lineColors=a.barColors=this.$colors,"Donut"===this.className&&(a.formatter=function(a,b){return"percent"in b?a+"("+b.percent+"%)":a}),a.ykeys&&!_.isArray(a.ykeys)&&(this.src.ykeys=a.ykeys=a.ykeys.split(",")),a.labels&&!_.isArray(a.labels)&&(this.src.labels=a.labels=a.labels.split(",")),a.yFormater&&(a.yFormater=tp.utils.decodeURLParam(a.yFormater)),this.options=a},showEmpty:function(){this.$el.addClass("empty").text("（无数据）")},collection_fetchHandler:function(){0===this.collection.length&&this.showEmpty();var a=this.collection.toJSON();this.collection.options&&(this.collection.options.ykeys&&(this.options.ykeys=this.src.ykeys.concat(this.collection.options.ykeys)),this.collection.options.labels&&(this.options.labels=this.src.labels.concat(this.collection.options.labels))),this.options.yFormater&&(a=a.map(function(a){return _.mapObject(a,function(a,b){return b in this.options.yFormater?Handlebars.helpers[this.options.yFormater[b]](a):a},this)},this)),this.options.data=a,this.render()}})}(Nervenet.createNameSpace("tp.component")),function(a){var b=Handlebars.compile('<a href="#/{{key}}/{{value}}" class="filter label label-{{key}}">{{#if label}}{{label}}{{else}}{{value}}{{/if}}</a>');a.SmartTable=a.BaseList.extend({$context:null,$ranger:null,autoFetch:!0,events:{"click .archive-button":"archiveButton_clickHandler","click .delete-button":"deleteButton_clickHandler","click .edit":"edit_clickHandler","click tbody .filter":"tbodyFilter_clickHandler","click thead .filter":"theadFilter_clickHandler","click .order":"order_clickHandler","change select.edit":"select_changeHandler","change .stars input":"star_changeHandler","change .status-button":"statusButton_changeHandler"},initialize:function(b){this.model=this.model&&this.model instanceof tp.model.TableMemento?this.model:new tp.model.TableMemento,this.model.on("change",this.model_changeHandler,this),this.model.on("invalid",this.model_invalidHandler,this),this.renderHeader();var c=this.$el.data(),d="autoFetch"in c?c.autoFetch:this.autoFetch,e="typeahead"in c?c.typeahead:!0;a.BaseList.prototype.initialize.call(this,_.extend(b,{autoFetch:!1,container:"tbody",reset:!0})),"search"in b&&(this.search=new a.table.Search({el:b.search,model:this.model,collection:this.collection})),"pagesize"in b&&b.pagesize>0&&(this.pagination=new a.table.Pager(_.extend({},b,{el:"pagination"in b?b.pagination:".pager",model:this.model,collection:this.collection}))),"pagesizeController"in b&&(this.pagesizeController=$(b.pagesizeController),this.pagesizeController.val(this.collection.pagesize),this.pagesizeController.on("change",_.bind(this.pagesize_changeHandler,this))),"ranger"in b&&(this.model.set(_.pick(b,"start","end"),{silent:!0}),this.$ranger.use(this.model)),"filter"in b&&(this.filter=new a.table.Filter({el:b.filter,model:this.model,collection:this.collection})),document.body.clientWidth>=768&&0===this.$el.closest("modal").length&&e&&(this.header=new a.table.FixedHeader({target:this})),d&&this.refresh(b),this.options=b},remove:function(){this.pagination&&this.pagination.remove(),this.pagesizeController&&this.pagesizeController.off("change"),this.ranger&&this.ranger.remove(),this.filter&&this.filter.remove(),this.header&&this.header.remove(),this.model.off(null,null,this),this.collection.off(null,null,this),tp.model.ListCollection.destroyInstance(this.$el.data("collection-id")),a.BaseList.prototype.remove.call(this)},render:function(){if(a.BaseList.prototype.render.call(this),this.$context.trigger("table-rendered",this),this.trigger("table-rendered",this),"order"in this.model.changed||"seq"in this.model.changed){var b=this.container;this.collection.each(function(a){b.append(b.find("#"+a.id))})}},refresh:function(a){a=a||{},a.data=_.extend(this.model.toJSON(),this.params,a.data),this.collection.fetch(a)},renderHeader:function(){var a=this.model.get("order"),c=this.model.get("seq"),d=this.model.omit("keyword","order","seq","start","end"),e=_.chain(d).omit(function(a,b){return b.match(/_label$/)}).map(function(a,c){var e={key:c,value:a};return d[c+"_label"]&&(e.label=d[c+"_label"]),b(e)}).value();a&&(this.$(".order").removeClass("active inverse"),this.$(".order[href=#"+a+"]").addClass("active").toggleClass("inverse","desc"==c)),this.$(".filters").append(e.join())},saveModel:function(a,b,c,d,e){a.spinner(),this.collection.get(b).save(c,d,{patch:!0,wait:!0,context:this,success:function(){a.spinner(!1),e&&e.remove&&this.collection.remove(b,{fadeOut:!0})}})},archiveButton_clickHandler:function(a){var b=$(a.currentTarget),c=b.data("msg")||"确定归档么？";if(confirm(c)){var d=b.closest("tr").attr("id");this.saveModel(b,d,b.attr("name"),b.val(),{remove:!0})}},collection_syncHandler:function(){if(a.BaseList.prototype.collection_syncHandler.call(this),this.model.waiting=!1,this.options.amount){var b=this.collection.getAmount(this.options.omits);this.collection_addHandler(b,null,{immediately:!0})}},deleteButton_clickHandler:function(a){var b=$(a.currentTarget),c=b.data("msg")||"确定删除么？";if(confirm(c)){var d=b.closest("tr").attr("id");b.spinner(),this.collection.get(d).destroy({fadeOut:!0,wait:!0,error:function(a,c){var d="responseJSON"in c?c.responseJSON:c;b.spinner(!1),alert(d.msg||"删除失败")}}),a.preventDefault()}},edit_clickHandler:function(a){if("select"!==a.currentTarget.tagName.toLowerCase()){var b=$(a.currentTarget),c=b.data(),d=b.closest("td").index(),e=a.currentTarget.hash.substr(1),f=b.closest("tr").attr("id"),g=this.collection.get(f),h=_.extend({label:this.$("thead th").eq(d).text()},c);h.type=c.type||"short-text",this.$context.trigger("edit-model",g,e,h),a.stopPropagation(),a.preventDefault()}},model_changeHandler:function(a,b){
b=_.omit(b,"unset")||{},this.refresh(b),("start"in a.changed||"end"in a.changed)&&_.extend(this.collection.model.prototype.defaults,_.pick(a.changed,"start","end")),this.$el.addClass("loading"),a.warting=!0},model_invalidHandler:function(a,b){alert(b)},order_clickHandler:function(a){var b=$(a.currentTarget),c=b.attr("href").substr(1);this.$(".order.active").not(b).removeClass("active inverse"),b.toggleClass("inverse",b.hasClass("active")&&!b.hasClass("inverse")).addClass("active"),this.model.set({order:c,seq:b.hasClass("inverse")?"desc":"asc"}),a.preventDefault()},pagesize_changeHandler:function(a){this.collection.setPagesize(a.target.value),this.refresh()},select_changeHandler:function(a){var b=$(a.currentTarget),c=b.closest("tr").attr("id");this.saveModel(b,c,b.attr("name"),b.val())},star_changeHandler:function(a){var b=$(a.currentTarget),c=b.closest("tr").attr("id");this.saveModel(b.add(b.siblings(".star")),c,b.attr("name"),b.val())},statusButton_changeHandler:function(a){var b=$(a.currentTarget),c=_.extend({active:1,deactive:0},b.data()),d=b.prop("checked")?c.active:c.deactive,e=b.closest("tr").attr("id"),f=$(b[0].labels).filter(".btn");this.saveModel(f,e,b.attr("name"),d)},tbodyFilter_clickHandler:function(a){var b=$(a.currentTarget),c=b.text(),d=b.attr("href").split("/").slice(-2),e=this.model.has(d[0]),f={};f[d[0]]=d[1],d[0]!=c&&(f[d[0]+"_label"]=c),this.model.set(f,{reset:!0}),e?this.$(".filters").find('[href="#/'+d[0]+'"]').replaceWith(b.clone()):this.$(".filters").append(b.clone()),a.preventDefault()},theadFilter_clickHandler:function(a){var b=$(a.currentTarget),c=b.attr("href").split("/").slice(-2);this.model.unset(c[0],{reset:!0}),b.remove(),a.preventDefault()}})}(Nervenet.createNameSpace("tp.component")),function(a){a.Typeahead=Backbone.View.extend({timeout:null,delay:500,events:{"blur .keyword":"keyword_blurHandler","focus .keyword":"keyword_focusHandler","change .result input":"result_changeHandler","click .options a":"options_clickHandler",keydown:"keyDownHandler",input:"inputHandler"},initialize:function(a){a=_.extend(a,this.$el.data()),this.result=this.$(".result"),this.list=this.$(".options"),this.result_template=Handlebars.compile(this.result.find("script").html()),this.list_template=Handlebars.compile(this.list.find("script").html().replace(/\s{2,}|\n|\r/g,"")),this.spinner=this.$(".fa-spinner"),this.input=this.$(".keyword"),this.collection=tp.model.ListCollection.getInstance(a),this.collection.on("sync",this.collection_syncHandler,this),this.selected=new Backbone.Collection,this.selected.on("add",this.selected_addHandler,this),this.selected.on("remove",this.selected_removeHandler,this),this.fetch=_.bind(this.fetch,this),this.error=_.bind(this.errorHandler,this),this.hide=_.bind(this.hide,this),this.multiple=a.multiple},remove:function(){this.collection.off(null,null,this),this.selected.off(),this.selected=null,Backbone.View.remove.call(this)},fetch:function(){this.xhr&&this.xhr.abort(),this.xhr=this.collection.fetch({data:{keyword:this.input.val()},reset:!0,error:this.error}),this.spinner.show()},hide:function(a){a&&$.contains(this.el,a.target)||this.list.hide()},collection_syncHandler:function(a){var b=a.toJSON(),c=this.list_template({list:b});c=c||this.list_template({error:!0,msg:"没有结果，请修改关键词，然后再试。"}),this.list.html(c).show(),this.spinner.hide(),this.input.focus(),this.xhr=null},keyword_blurHandler:function(){var a=this.list;this.hideTimeout=setTimeout(function(){a.hide()},250)},keyword_focusHandler:function(){clearTimeout(this.hideTimeout),this.collection.length>0&&this.list.show()},options_clickHandler:function(a){var b=a.target.hash.substr(1);this.multiple?(this.selected.add(this.collection.get(b)),this.input.focus()):(this.selected.set([this.collection.get(b)]),this.list.hide()),a.preventDefault()},result_changeHandler:function(a){var b=a.target;if(!b.checked){var c=b.id.substr(9);this.selected.remove(c)}},selected_addHandler:function(a){var b=this.result_template(a.toJSON());this.result.append(b)},selected_removeHandler:function(a){var b=a.id;this.$("#selected-"+b+",[for=selected-"+b+"]").remove()},errorHandler:function(){this.spinner.hide(),this.list.append(this.list_template({error:!0,msg:"加载错误，大侠请重新来过"}))},inputHandler:function(){clearTimeout(this.timeout),this.input.val().length>1&&(this.timeout=setTimeout(this.fetch,this.delay))},keyDownHandler:function(a){var b=this.list.find(".active").removeClass("active");switch(a.keyCode){case 13:var c=b.children().attr("href");c?(c=c.substr(1),this.multiple?this.selected.add(this.collection.get(c)):(this.selected.set([this.collection.get(c)]),this.list.hide())):!this.input.prop("disabled")&&this.input.val().length>1&&this.fetch(),a.preventDefault();break;case 40:this.list.show(),0===b.length||b.is(":last-child")?this.list.children().eq(0).addClass("active"):b.next().addClass("active"),a.preventDefault();break;case 38:this.list.show(),0===b.length||b.is(":first-child")?this.list.children().last().addClass("active"):b.prev().addClass("active"),a.preventDefault();break;case 27:this.list.is(":visible")&&(this.hide(),a.stopPropagation())}}})}(Nervenet.createNameSpace("tp.component"))}();