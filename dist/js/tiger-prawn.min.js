/*! tiger-prawn Version 0.3.0
 2015-07-22 */
"use strict";!function(){!function(a){var b=a.sync;a.sync=function(a,c,d){return d=d||{},"xhrField"in d?d.xhrFields.withCredentials=!0:d.xhrFields={withCredentials:!0},b(a,c,d)},a.Model.prototype.isNew=function(){return!this.id}}(Backbone),function(a){var b=Array.prototype.slice,c=Array.prototype.pop,d={};a.registerHelper("pick",function(a,c){return a=parseInt(a),c=_.isArray(c)||_.isObject(c)?c:b.call(arguments,1,-1),c[a]}),a.registerHelper("pick_with",function(a,d,e){if(a=parseInt(a),d=_.isArray(d)?d:b.call(arguments,1,-1),e=c.call(arguments),_.isObject(d[0])){for(var f,g=e.hash.key||"id",h=0,i=d.length;i>h;h++)if(d[h][g]==a){f=d[h];break}return f?e.fn(f):""}return e.fn(d[a+e.hash.offset])}),a.registerHelper("substring",function(a,b,c){return a?a.substr(b,c):""}),a.registerHelper("text-collapse",function(a,b){return a?a.length<b?a:'<abbr title="'+a+'">'+a.substr(0,b)+"...</abbr>":""}),a.registerHelper("ext",function(a){return a?a.substr(a.lastIndexOf(".")+1):""}),a.registerHelper("d100",function(a){return(a/100).toFixed(2)}),a.registerHelper("short_n",function(a){if(_.isNaN(a))return a;for(var b=["万","亿"],c=a,d=0;a/1e4>=1;)a/=1e4,c=(a%1===0?a:(100*a>>0)/100)+b[d],d++;return c}),a.registerHelper("moment",function(a){return a?moment(a).calendar():""}),a.registerHelper("from-now",function(a){return a?moment(a).fromNow():""}),a.registerHelper("equal",function(a,b,c){return a==b?c.fn(this):c.inverse(this)}),a.registerHelper("in",function(a,d,e){return _.isArray(d)||(e=c.call(arguments),d=b.call(arguments,1)),-1!==d.indexOf(a)?e.fn(this):e.inverse(this)}),a.registerHelper("raw-helper",function(a){return a.fn()}),a.registerHelper("json",function(a){return JSON.stringify(a)}),a.registerHelper("inject",function(b,c){var d=a.$context;return b=d.getValue(b),b instanceof Backbone.Model?b.get(c):b[c]}),a.registerHelper("counter",function(a){return a=a||"_",d[a]=d[a]||1,d[a]++}),a.registerHelper("counter-reset",function(a){return a=a||"_",d[a]=1,""})}(Handlebars),function(a){a.fn.spinner=function(b){return b=void 0===b?!0:b,this.each(function(){if("a"===this.tagName.toLowerCase())a(this).toggleClass("disabled",b);else{if("button"!==this.tagName.toLowerCase())return!0;a(this).prop("disabled",b)}a(this).find("i").toggle(!b),b?a(this).prepend(tp.component.spinner):a(this).find(".fa-spin").remove()})}}(jQuery),function(a){a.DATE_FORMAT="YYYY-MM-DD",a.TIME_FORMAT="HH:mm:ss",a.defaultFormat=a.DATE_FORMAT+" "+a.TIME_FORMAT}(moment),function(){var a={};try{localStorage.setItem("tp",1),localStorage.removeItem("tp")}catch(b){localStorage.setItem=function(b,c){a[b]=c},localStorage.getItem=function(b){return a[b]}}}(),function(a){a.Base=Backbone.Router.extend({$body:null,$me:null,routes:{"user/:page":"showUserPage","dashboard(/)":"showDashboard"},showDashboard:function(){this.$body.load("page/dashboard.hbs",new tp.model.Dashboard)},showUserPage:function(a){return"logout"===a?this.$me.destroy({success:function(a){a.clear(),location.hash="#/user/login"}}):"login"===a&&this.$me.id?void this.navigate(tp.startPage||"#/dashboard"):(tp.config.login.api=this.$me.url,this.$body.load(tp.path+"page/"+a+".hbs",tp.config.login,{isFull:!0}),void this.$body.setFramework("login"))}})}(Nervenet.createNameSpace("tp.router")),function(a){var b={dataType:"json",type:"post",cache:!1,xhrFields:{withCredentials:!0}},c={$body:null,$me:null,call:function(a,c,d){d=_.extend({url:a,data:c},b,d);var e=this,f=d.error||this.onError,g=d.success||this.onSuccess;d.success=function(a){0===a.code?(e.postHandle(a),g.call(d.context,a),e.trigger("complete:call",a)):f(a)},d.error=function(a,b,c){f.call(d.context,a,b,c)},$.ajax(d)},postHandle:function(a){"me"in a&&this.$me.set(a.me)},onError:function(a,b,c){401===b&&this.$body.load("page/error.html")},onProgress:function(a,b){},onSuccess:function(a){}};c=_.extend(c,Backbone.Events),a.Manager=c}(Nervenet.createNameSpace("tp.service")),function(a){{var b,c=Backbone.View.extend({$context:null,events:{"click .popup":"popupButton_clickHandler"},initialize:function(){this.template=Handlebars.compile(this.$("#popup").remove().html()),this.editor=Handlebars.compile(this.$("#editor-popup").remove().html())},postConstruct:function(){b&&this.$context.inject(b)},popup:function(b){var c=$(this.template(b)),d=Nervenet.parseNamespace(b.popup)||a.Base;return this.$el.append(c),c=this.$context.createInstance(d,_.extend({el:c},b))},popupEditor:function(a){var b=a.el=$(this.editor(a));return this.$el.append(b),b=d.createEditor(this.$context,a)},popupButton_clickHandler:function(a){var b=a.currentTarget,c=$(b).data();if(c.collectionId){var d=tp.model.ListCollection.getInstance(c);c.model=d.get(c.id)}"a"===b.tagName.toLowerCase()&&(c.content=b.href,c.isRemote=!0),c.title=c.title||b.title,this.popup(c),a.preventDefault()}}),d={createEditor:function(b,c){var d;switch(c.type){case"file":d=b.createInstance(a.FileEditor,c);break;case"number":case"range":d=b.createInstance(a.NumberEditor,c);break;case"search":d=b.createInstance(a.SearchEditor,c);break;case"select":d=b.createInstance(a.SelectEditor,c);break;case"tags":d=b.createInstance(a.TagsEditor,c);break;case"status":d=b.createInstance(a.SwitchEditor,c);break;case"checkbox":d=b.createInstance(a.CheckboxEditor,c);break;default:d=b.createInstance(a.Editor,c)}return d}};a.Manager=new c({el:"body"})}}(Nervenet.createNameSpace("tp.popup")),function(a){a.decodeURLParam=function(a){if(!a)return{};for(var b=a.split("&"),c={},d=0,e=b.length;e>d;d++){var f=b[d].split("=");c[f[0]]=decodeURIComponent(f[1])}return c}}(Nervenet.createNameSpace("tp.utils")),function(a){a.Error={getAjaxMessage:function(a,b,c){if("500"===a.statusCode().status)return{message:"服务器错误，请告知管理员",icon:"close"};if(0===a.status)return{message:"连接超时，请检查您的网络。",icon:"close"};var d=(a.responseJSON?a.responseJSON.msg:null)||c||"",e="frown-o";return"error"!==b||a.responseText||(d="请求服务器失败，请重试。若连续失败，请联系管理员。",e="user-md"),{message:d,icon:e}}}}(Nervenet.createNameSpace("tp")),function(a){function b(a,b,c){c.model=a,c.prop=b,tp.popup.Manager.popupEditor(c)}a.editModelCommand=function(a,c,d){d=_.extend({},d),d.value=a.get(c),b(a,c,d)}}(Nervenet.createNameSpace("tp.controller")),function(a){a.addModelCommand=function(a){var b=tp.model.ListCollection.getInstance(a),c=new b.model(null,a);a.isRemote=!0,a.content="page/"+a.template,c.options=b.options,c.urlRoot=b.url,c.key=b.key,a.model=c;var d=tp.popup.Manager.popup(a);d.on("success",function(){b.add(c,{immediately:!0,prepend:!0,merge:!0})})}}(Nervenet.createNameSpace("tp.controller")),function(a){var b="ad_owner",c="您刚刚上传的包和之前的报名不同，可能有误。您确定要保存么？";a.AD=Backbone.Model.extend({defaults:{ad_app_type:1,ad_type:0,cate:0,cpc_cpa:"cpa",put_net:0,province_type:0,put_jb:0,put_ipad:0,net_type:0,down_type:0,feedback:2,cycle:2},urlRoot:tp.API+"ad/",initialize:function(a,b){Backbone.Model.prototype.initialize.call(this,a,b),this.isNew()&&(this.isEmpty=!0,this.urlRoot+="init",this.on("sync",this.syncHandler,this))},parse:function(a){a.options&&(this.options=a.options,this.options.API=tp.API,this.options.UPLOAD=tp.UPLOAD);var c=a.ad&&_.isObject(a.ad);return c&&!a.ad.owner&&(a.ad.owner=Number(localStorage.getItem(b))),c?a.ad:a},save:function(a,c,d){return"owner"===a&&c&&localStorage.setItem(b,c),a.owner&&localStorage.setItem(b,a.owner),Backbone.Model.prototype.save.call(this,a,c,d)},toJSON:function(a){var b=Backbone.Model.prototype.toJSON.call(this,a);if(a)return b;var c=this.previousAttributes();return _.isEmpty(c)||(b.previous=c),_.extend(b,this.options)},validate:function(a){var b=this.get("pack_name");return b&&a.pack_name!==b&&!confirm(c)?"新包名与之前不一致，请检查后重新上传。":void 0},syncHandler:function(){"id"in this.changed&&(location.hash="#/ad/"+this.id,this.urlRoot=tp.API+"ad/")}})}(Nervenet.createNameSpace("tp.model")),function(a){a.Dashboard=Backbone.Model.extend({className:"dashboard",url:tp.API+"dashboard/",parse:function(a){return"record"in a.data&&_.each(a.data.record,function(a){a.is_checked=a.status<2}),a.data}})}(Nervenet.createNameSpace("tp.model")),function(a){a.Me=Backbone.Model.extend({$body:null,url:tp.API+"user/",initialize:function(){this.on("change:id",this.id_changeHandler,this)},fetch:function(a){Backbone.Model.prototype.fetch.call(this,_.extend({error:_.bind(this.onError,this)},a))},parse:function(a){return a.me},id_changeHandler:function(a,b){if(b){this.$body.start(!0),tp.notification.Manager.start();var c;if(Backbone.History.started||(c=Backbone.history.start({root:tp.BASE})),!c||/^#\/user\/\w+$/.test(location.hash)){var d=localStorage.getItem(tp.PROJECT+"-from");d=/^#\/user\/log(in|out)$/.test(d)?"":d,location.hash=d||tp.startPage||"#/dashboard"}}else if(this.$body.isStart&&"#/user/logout"!==location.hash){var e=tp.config.login;e.welcome="登录已失效，请重新登录",e.api=this.url,tp.popup.Manager.popup(_.extend({title:"登录",content:"page/login.hbs",confirm:"登录",cancel:"退出",isRemote:!0},e))}else localStorage.setItem(tp.PROJECT+"-from",location.hash),location.hash="#/user/login"},onError:function(){this.$body.start(),localStorage.setItem(tp.PROJECT+"-from",location.hash),location.hash="#/user/login",Backbone.history.start({root:tp.BASE})}})}(Nervenet.createNameSpace("tp.model")),function(a){var b={},c=Backbone.Model.extend({parse:function(a){var b=this.key||(this.collection?this.collection.key:"data");return"code"in a&&"msg"in a&&b in a?a[b]:a},toJSON:function(a){var b=Backbone.Model.prototype.toJSON.call(this,a);if(a)return b;var c=this.previousAttributes();return _.isEmpty(c)||(b.previous=c),_.extend(b,this.options,this.collection?this.collection.options:null)}}),d=a.ListCollection=Backbone.Collection.extend({total:0,pagesize:10,isLoading:!1,initialize:function(a,b){if(this.key=b.key||"data",this.save=tp.PROJECT+location.hash+"-pagesize",Backbone.Collection.prototype.initialize.call(this,a,b),b){b.url&&(this.url=b.url);var c=localStorage.getItem(this.save);this.pagesize=c||b.pagesize||this.pagesize}},fetch:function(a){this.isLoading||(a=a||{},a.data?a.data.pagesize=this.pagesize:a.data={pagesize:this.pagesize},Backbone.Collection.prototype.fetch.call(this,a),this.isLoading=!0)},parse:function(a){this.isLoading=!1,this.total=_.isArray(a)?a.length:a.total,a.options&&(this.options=a.options);for(var b in _.omit(a,"total","list","options","code","msg"))a.hasOwnProperty(b)&&_.isArray(a[b])&&this.trigger("data:"+b,a[b]);return _.isArray(a)?a:a.list},setPagesize:function(a){this.pagesize=a,localStorage.setItem(this.save,a)}});d.getInstance=function(a){var e;if(a.collectionId&&a.collectionId in b)return e=b[a.collectionId],!e.url&&a.url&&(e.url=a.url),e;var f=_.extend({},a);if(!(f.model&&f.model instanceof Backbone.Model)){var g=_.pick(f,"idAttribute","defaults");f.model=_.isEmpty(g)?c:c.extend(g)}return e=new d(null,f),a.collectionId&&(b[a.collectionId]=e),e},d.destroyInstance=function(a){a in b&&delete b[a]}}(Nervenet.createNameSpace("tp.model")),function(a){var b=6e4,c=!1;a.Notice=Backbone.Collection.extend({latest:0,url:tp.API+"notice/",initialize:function(){this.on("sync",this.syncHandler,this),this.fetch=_.bind(this.fetch,this)},fetch:function(a){c=!0,a=_.extend({data:{latest:this.latest},remove:!1},a),Backbone.Collection.prototype.fetch.call(this,a)},parse:function(a){for(var b=0,c=a.list.length;c>b;b++)a.list[b].create_time=a.list[b].create_time.substr(5,11),this.latest=a.list[b].id>this.latest?a.list[b].id:this.latest;return a.list},stop:function(){c=!1,clearTimeout(b)},syncHandler:function(){c&&setTimeout(this.fetch,b)}})}(Nervenet.createNameSpace("tp.model")),function(a){a.TableMemento=Backbone.Model.extend({waiting:!1,initialize:function(){this.key=tp.PROJECT+location.hash;var a=localStorage.getItem(this.key);a&&(a=JSON.parse(a),this.set(a,{silent:!0})),this.on("change",this.changeHandler,this)},_validate:function(a,b){return"validate"in b||(b.validate=!0),Backbone.Model.prototype._validate.call(this,a,b)},validate:function(a,b){return this.waiting||"ignore"in b&&!b.ignore?"表格正在更新数据，请稍候。":void 0},changeHandler:function(){localStorage.setItem(this.key,JSON.stringify(this.omit("page","keyword")))}})}(Nervenet.createNameSpace("tp.model")),function(a){a.Detail=Backbone.Model.extend({parse:function(a){return a.options&&(this.options=a.options,this.options.API=tp.API,this.options.UPLOAD=tp.UPLOAD),a.list},toJSON:function(a){var b=Backbone.Model.prototype.toJSON.call(this,a);if(a)return b;var c=this.previousAttributes();return _.isEmpty(c)||(b.previous=c),_.extend(b,this.options)}})}(Nervenet.createNameSpace("tp.model")),function(a){a.DataSyncView=Backbone.View.extend({initialize:function(){this.submit=this.$("button.btn-primary")},displayProcessing:function(){this.$el.addClass("processing"),this.submit.spinner()},displayResult:function(a,b,c){b=(c?'<i class="fa fa-'+c+'"></i> ':"")+b,this.submit.spinner(!1),this.$el.removeClass("processing"),this.$(".alert-msg").hide().toggleClass("alert-danger",!a).toggleClass("alert-success",a).html(b+" ("+moment().format("HH:mm:ss")+")").slideDown()}})}(Nervenet.createNameSpace("tp.view")),function(a){a.Panel=tp.view.DataSyncView.extend({fragment:"",events:{"click input":"input_clickHandler","click .mark-all-button":"markAllButton_clickHandler","change [name=check]":"check_changeHandler",animationend:"animationEndHandler",webkitAnimationEnd:"animationEndHandler"},initialize:function(){this.template=Handlebars.compile(this.$("script").remove().html()),this.header=this.$(".dropdown-header"),this.button=this.$(".dropdown-toggle"),this.submit=this.$(".mark-all-button"),this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this),this.collection.on("remove",this.collection_removeHandler,this)},refreshNumber:function(){var a=this.$("input:not(:checked)").length;this.label&&this.label.remove(),0!==a&&(this.label=$("<span>"+(a>10?"10+":a)+"</span>").appendTo(this.button),this.button.find("i").addClass("animated swing"))},animationEndHandler:function(a){$(a.target).removeClass("animated swing")},check_changeHandler:function(a){var b=a.target.value;this.collection.get(b).destroy()},collection_addHandler:function(a){this.fragment+=this.template(a.toJSON())},collection_removeHandler:function(a){var b=this.$("#msg-"+a.id);this.refreshNumber(),setTimeout(function(){b.fadeOut(function(){$(this).remove()})},3e3)},collection_syncHandler:function(){this.fragment&&(this.header.after(this.fragment),this.refreshNumber(),this.fragment="")},input_clickHandler:function(a){a.stopPropagation()},markAll_errorHandler:function(a,b){this.displayResult(!1,b,"times")},markAll_successHandler:function(a){this.$(".alarm").remove(),this.label.remove(),this.displayResult(!0,a.msg,"check"),this.$(".alert").delay(3e3).slideUp()},markAllButton_clickHandler:function(a){var b=[];this.collection.each(function(a){b.push(a.id)}),this.collection.sync("delete",this,{url:this.collection.url+b.join(","),success:this.markAll_successHandler,error:this.markAll_errorHandler,context:this}),this.displayProcessing(),a.stopPropagation()}})}(Nervenet.createNameSpace("tp.notification")),function(a){a.Growl=Backbone.View.extend({count:0,fragment:[],initialize:function(){this.template=Handlebars.compile(this.$("script").remove().html()),this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this)},collection_addHandler:function(a){return this.count>2?void this.count++:(this.fragment.push(this.template(a.toJSON())),void this.count++)},collection_syncHandler:function(){this.fragment&&(this.count>3&&(this.fragment[2]=this.template({number:this.count-2})),this.$el.append(this.fragment.join("")),this.fragment=[])}})}(Nervenet.createNameSpace("tp.notification")),function(a){function b(){this.permission="",this.requestPermission=function(){}}var c,d="Notification"in window?Notification:new b;"hidden"in document?c="hidden":"webkitHidden"in document?c="webkitHidden":"mozHidden"in document?c="mozHidden":"msHidden"in document&&(c="msHidden");{var e=Backbone.View.extend({count:0,initialize:function(){if("granted"!==d.permission)try{d.requestPermission()}catch(a){}this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this)},createDesktopNotice:function(){document[c]&&"granted"===d.permission&&new d("点乐自助平台通知",{icon:"img/fav.png",body:"收到"+this.count+"条通知，请及时处理哟。"})},start:function(){this.collection.fetch()},stop:function(){this.collection.stop()},collection_addHandler:function(){this.count++},collection_syncHandler:function(){this.count>0&&(this.createDesktopNotice(this.count),this.count=0)}}),f=new tp.model.Notice;new a.Panel({el:".system-notice",collection:f}),new a.Growl({el:"#growl",collection:f})}tp.NOTICE_KEY&&(a.Manager=new e({collection:f}))}(Nervenet.createNameSpace("tp.notification")),function(a){function b(a,b){if(0!==b.length){b=_.isArray(b)?b:[b];var c=b.join("<br />");$(a).popover({trigger:"manual",title:"表单填写有误",content:c,html:!0}).popover("show").one("focus",function(){$(this).off(".popover").removeData("popover").siblings(".popover").remove().end().closest(".form-group").removeClass("error")}).closest(".form-group").addClass("error")}}var c="history-recorder",d=a.SmartForm=tp.view.DataSyncView.extend({$router:null,uploaders:[],events:{"blur input,textarea":"input_blurHandler","focus input":"input_focusHandler",submit:"submitHandler",data:"dataHandler","click .collapsible legend":"legend_clickHandler"},initialize:function(){this.submit=this.getSubmit(),this.model instanceof Backbone.Model&&this.model.on("invalid",this.model_invalidHandler,this),this.initUploader()},remove:function(){this.model.off(null,null,this),_.each(this.uploaders,function(a){a.off("data"),a.remove&&a.remove()}),this.uploaders=null,Backbone.View.prototype.remove.call(this)},validate:function(){var a=this.el.elements;return this.$el.hasClass("uploading")?(alert("上传文件中，请稍候"),!1):"newpassword"in a&&a.newpassword.value!==a.repassword.value?(b(a.repassword,"两次密码不一致哟，麻烦检查下吧"),!1):"password"in a&&!/^[0-9a-zA-Z$!^#_@%&*.]{6,32}$/.test(a.password.value)?(b(a.password,"密码应为6~16个字符，请重新填写"),!1):!0},checkInput:function(a){if(a.prop("required")&&""===a.val())return"此项为必填项，您好像漏掉了哟";var b=a.attr("pattern");if(b&&""!==a.val()&&!new RegExp(b).test(a.val()))return"填写格式有误，麻烦您检查并重新填写";if(/number/i.test(a.attr("type"))&&(void 0!==a.attr("min")||void 0!==a.attr("max"))){var c=Number(a.val());if(isNaN(c))return"此项只能输入数字";if(void 0!==a.attr("min")&&c<a.attr("min")||void 0!==a.attr("max")&&c>a.attr("max"))return"数值超出规定范围"}return"password"!==a.attr("type")||/^[0-9a-zA-Z$!^#_@%&*.]{6,32}$/.test(a.val())?"":"密码应为6~16个字符，包含字母、数字、特殊符号等"},getSubmit:function(){var a="button:not([type=button]), input[type=submit]",b=this.$(a);if(0===b.length){var c=this.$el.attr("id");b=$(a).filter("[form="+c+"]")}return b},initUploader:function(){var a=this.model?this.model.id:null,b=this,c=this.uploaders;this.$(".uploader").each(function(){var d=$(this).data();a&&(d.data={id:a});var e=new meathill.SimpleUploader(this,d);e.on("start",b.uploader_startHandler,b),e.on("data",b.uploader_dataHandler,b),c.push(e)}),this.$(".fetcher").each(function(){var a=new tp.component.FileFetcher({el:this,model:b.model});a.on("start",b.uploader_startHandler,b),a.on("data",b.uploader_dataHandler,b),c.push(a)})},useData:function(a){for(var b in a){if(!a.hasOwnProperty(b))return;var c=a[b];if(_.isArray(c))this.$('[name="'+b+'[]"]').each(function(){this.checked=-1!==c.indexOf(this.value)});else{var d=this.$("[name= "+b+"]:not([type=radio])").val(c);try{d.length>0||this.$("[name="+b+"][value="+c+'], [name="'+b+'[]"][value='+c+"]").prop("checked",!0)}catch(e){}"hidden"===d.attr("type")&&d.trigger("change")}}},input_blurHandler:function(a){var b=$(a.currentTarget),c=this.checkInput(b);c&&(this.$("input").tooltip("destroy"),b.tooltip({title:c,placement:"bottom",trigger:"manual"}).tooltip("show"))},input_focusHandler:function(a){$(a.currentTarget).tooltip("destroy")},legend_clickHandler:function(a){$(a.currentTarget).toggleClass("collapsed")},model_invalidHandler:function(a,b){this.displayResult(!1,b,"times"),this.trigger("error",null,1,{message:b})},submit_successHandler:function(a){this.displayResult(!0,a.msg,"smile-o"),d.recordHistory(this.el),this.$el.trigger("success",a),this.trigger("success",a)},submit_errorHandler:function(a,b,c){c=tp.Error.getAjaxMessage(a,b,c),this.displayResult(!1,c.message,c.icon),this.trigger("error",a,b,c)},uploader_dataHandler:function(a){this.$el.removeClass("uploading"),this.useData(a)},uploader_startHandler:function(){this.$el.addClass("uploading")},dataHandler:function(a,b){this.useData(b)},submitHandler:function(a){if(!this.$el.is(":hidden")){var b=this.el,c=b.action;if(this.$el.hasClass("fake")||this.$el.hasClass("loading"))return a.preventDefault(),!1;-1!==c.indexOf("#")&&(c=c.substr(c.indexOf("#")),c=c.replace(/\/:(\w+)/g,function(a,c){return"/"+b.elements[c].value}),location.href=c,a.preventDefault()),this.displayProcessing();var d=this.validate();if(this.$el.hasClass("ajax")&&d){var e=this.$el.serialize();return tp.service.Manager.call(c,e,{success:this.submit_successHandler,error:this.submit_errorHandler,context:this,method:this.$el.attr("method")}),!1}if(this.$el.hasClass("model-editor")&&d){var f={},g=this;return _.each(this.$el.serializeArray(),function(a){var b=a.name.replace("[]",""),c=isNaN(a.value)?a.value:Number(a.value);void 0!==f[b]?(_.isArray(f[b])||(f[b]=[f[b]]),f[b].push(c)):f[b]=c},this),this.$(".switch").each(function(){var a=!isNaN(parseInt(this.value)),b=a?Number(this.value):this.value;b=this.checked?b:!b,f[this.name]=a?Number(b):b}),this.model.save(f,{patch:!0,wait:!0,success:function(a,b){g.submit_successHandler(b)},error:function(a,b){g.submit_errorHandler(b)}}),!1}return d}}});d.recordHistory=function(a,b){var d=document.getElementById(c).contentWindow.document;if(a.tagName&&"form"===a.tagName.toLowerCase())a=a.cloneNode(!0);else{var e=document.createElement("input");e.name=a,e.value=b,a=document.createElement("form"),a.action="about:blank",a.appendChild(e)}d.body.appendChild(a),a.onsubmit=null,a.submit(),d.body.innerHTML=""},$(document).on("change","[type=range]",function(a){$(a.target).next().html(a.target.value)}).on("change",".auto-submit",function(a){$(a.target).closest("form").submit()}).on("change",".check-all",function(a){var b=a.target,c=b.value,d=b.checked;$('[name="'+c+'"]').prop("checked",d)})}(Nervenet.createNameSpace("tp.component")),function(a){a.BaseList=Backbone.View.extend({fragment:"",initialize:function(a){this.template=Handlebars.compile(this.$("script").remove().html().replace(/\s{2,}|\n/g,"")),this.container=a.container?this.$(a.container):this.$el,this.collection.on("add",this.collection_addHandler,this),this.collection.on("change",this.collection_changeHandler,this),this.collection.on("remove",this.collection_removeHandler,this),this.collection.on("sync",this.collection_syncHandler,this),this.collection.on("reset",this.collection_resetHandler,this)},remove:function(){this.collection.off(null,null,this),Backbone.View.prototype.remove.call(this)},render:function(){this.$(".waiting").hide(),this.container.append(this.fragment),this.fragment="",this.$el.removeClass("loading")},collection_addHandler:function(a,b,c){if(this.fragment+=this.template(a.toJSON()),c&&c.immediately){var d=$(this.fragment);return d.attr("id",a.id||a.cid),this.container[c.prepend?"prepend":"append"](d),this.fragment="",d}},collection_changeHandler:function(a){var b=this.template(a.toJSON());$(document.getElementById(a.id||a.cid)).replaceWith(b)},collection_removeHandler:function(a,b,c){var d=$(document.getElementById(a.id||a.cid));c.fadeOut?d.fadeOut(function(){$(this).remove()}):d.remove()},collection_resetHandler:function(){this.container.empty(),this.collection.each(function(a){this.collection_addHandler(a)},this),this.render()},collection_syncHandler:function(){this.render()}})}(Nervenet.createNameSpace("tp.component")),function(a){a.FileFetcher=Backbone.View.extend({events:{"click .fetch-button":"fetchButton_clickHandler","change [name]":"input_changeHandler"},validate:function(a){var b=/^https?:\/\//;return b.test(a)},fetchButton_clickHandler:function(){var a=this.$("[name=ad_url]"),b=a.val();if(b&&"hidden"!==a.attr("type")){if(/itunes\.apple\.com/.test(b))return void alert("App Store应用暂时不支持抓取");tp.service.Manager.call(tp.API+"fetch/",{type:"ad_url",id:this.model.id,file:b},{context:this,success:this.fetchFile_successHandler,error:this.fetchFile_errorHandler}),this.$(".fetch-button").prop("disabled",!0).find("i").addClass("fa-spin fa-spinner"),this.$("[name=ad_url]").prop("disabled",!0)}},fetchFile_successHandler:function(a){alert("服务器抓取文件成功"),this.trigger("data",a.form),this.$(".fetch-button").prop("disabled",!1).find("i").removeClass("fa-spin fa-spinner"),this.$("[name=ad_url]").prop("disabled",!1)},fetchFile_errorHandler:function(a){alert(a.msg)},input_changeHandler:function(a){a.target.value=a.target.value.replace(/\s/g,"");var b=this.validate(a.target.value);this.$(".fetch-button").toggleClass("btn-warning",b).prop("disabled",!b)}})}(Nervenet.createNameSpace("tp.component")),function(a){var b="YYYY-MM-DD";a.Pager=Backbone.View.extend({events:{"click a":"clickHandler"},initialize:function(a){this.template=this.$("script").remove().html()||"",this.template=this.template?Handlebars.compile(this.template):!1,this.pagesize=this.collection.pagesize,this.total=Math.ceil(a.length/this.pagesize),this.render(),this.displayPageNum(),this.collection.on("sync",this.collection_syncHandler,this)},remove:function(){this.collection.off(null,null,this),this.model=this.collection=null,Backbone.View.prototype.remove.call(this)},render:function(){if(this.template){for(var a=this.model.get("page"),b=[],c=a-5>0?a-5:0,d=c+10<this.total?c+10:this.total,e=d-c,f=0;e>f;f++)b[f]={index:f+c,label:f+c+1};this.$el.html(this.template({pages:b,prev:a-1,next:a+1}))}},displayPageNum:function(){var a=this.model.get("page")||0,b=this.total;this.$('[href="#/to/'+a+'"]').closest(".hidden-xs").addClass("active").siblings().removeClass("active"),this.$el.each(function(){$(this).children().first().toggleClass("disabled",0===a).end().last().toggleClass("disabled",a>=b-1)})},setTotal:function(a,b){this.pagesize=b||this.pagesize,this.total=Math.ceil(a/this.pagesize),this.render(),this.displayPageNum()},collection_syncHandler:function(){this.setTotal(this.collection.total,this.collection.pagesize)},clickHandler:function(a){var b=$(a.currentTarget),c=b.parent();if(c.hasClass("disabled")||c.hasClass("active"))return!1;var d=b.attr("href"),e=Number(d.substr(d.lastIndexOf("/")+1));this.model.set("page",e),b.html(tp.component.spinner),this.$el.children().addClass("disabled"),a.preventDefault()}}),a.Ranger=Backbone.View.extend({events:{"click .shortcut":"shortcut_clickHandler","click .range input":"input_clickHandler","click .range button":"range_clickHandler"},initialize:function(a){this.$("[type=date]").datetimepicker({format:b});var c=this.render(a);this.trigger(c,{silent:!0})},render:function(a){var c=_.extend({start:-31,end:0},_.pick(a,"start","end")),d=/^\d{4}-\d{2}-\d{2}$/;return d.test(c.start)&&d.test(c.end)||(c.start=moment().add(c.start,"days").format(b),c.end=moment().add(c.end,"days").format(b)),this.$("[name=start]").val(c.start),this.$("[name=end]").val(c.end),c},remove:function(){return this.stopListening(),this.el=this.$el=this.model=null,this},trigger:function(a,b){b=b||{},b.reset=!0,this.model.set(a,b)},input_clickHandler:function(a){a.stopPropagation()},range_clickHandler:function(){var a=this.$("[name=start]").val(),b=this.$("[name=end]").val();this.$(".shortcut").removeClass("active"),this.$(".label").text(a+" - "+b),this.trigger({start:a,end:b})},shortcut_clickHandler:function(a){var b=$(a.currentTarget),c=b.data("start"),d=b.data("end");b.addClass("active").siblings().removeClass("active"),this.$(".label").text(b.text());var e=this.render({start:c,end:d});this.trigger(e),a.preventDefault()}}),a.Search=Backbone.View.extend({events:{keydown:"keydownHandler"},initialize:function(){this.$el.val(this.model.get("keyword")),this.collection.on("sync",this.collection_syncHandler,this)},remove:function(){this.collection.off(null,null,this),this.collection=this.model=null,Backbone.View.prototype.remove.call(this)},collection_syncHandler:function(){this.$el.prop("readonly",!1),this.spinner&&this.spinner.remove()},keydownHandler:function(a){13===a.keyCode&&(this.model.unset("keyword",{silent:!0}),this.model.set({keyword:a.target.value,page:0}),this.$el.prop("readonly",!0),this.spinner=this.spinner||$(tp.component.spinner),this.spinner.insertAfter(this.$el),tp.component.SmartForm.recordHistory("keyword",a.target.value))}}),a.Filter=Backbone.View.extend({events:{change:"changeHandler"},initialize:function(){this.model.on("change",this.model_changeHandler,this),this.collection.on("sync",this.collection_syncHandler,this),this.render()},render:function(){var a=this.model.toJSON();for(var b in a)this.$("[name="+b+"]").val(a[b])},remove:function(){this.collection.off(null,null,this),this.collection=this.model=null,Backbone.View.prototype.remove.call(this)},collection_syncHandler:function(){this.$(".fa-spin").remove(),this.$("select").prop("disabled",!1)},model_changeHandler:function(){this.$("select").prop("disabled",!0)},changeHandler:function(a){var b=a.target,c=b.name,d=b.value;this.model.set(c,d,{reset:!0}),$(b).after(tp.component.spinner)}})}(Nervenet.createNameSpace("tp.component.table")),function(a){a.CollectionSelect=a.BaseList.extend({initialize:function(b){var c=this.$el.data();this.collection=tp.model.ListCollection.getInstance(c),a.BaseList.prototype.initialize.call(this,b),this.collection.length&&this.collection_resetHandler(),c.autoFetch&&this.collection.fetch()},collection_addHandler:function(b,c,d){var e=a.BaseList.prototype.collection_addHandler.call(this,b,c,d);e&&e.prop("selected",!0).siblings().prop("selected",!1)},collection_changeHandler:function(a){this.$("[value="+a.id+"]").prop("selected",!0).siblings().prop("selected",!1)}})}(Nervenet.createNameSpace("tp.component")),function(a){a.Manager={$context:null,map:{".smart-table":"tp.component.SmartTable",".add-on-list":"tp.component.AddOnList",".collection-select":"tp.component.CollectionSelect",".morris-chart":"tp.component.MorrisChart","#login-form":"tp.component.LoginForm",form:"tp.component.SmartForm"},check:function(a,b){var c=[];a.data("components",c);var d=a.find(".datetimepicker");d.length&&d.each(function(){$(this).datetimepicker($(this).data())});var e=this;for(var f in this.map)if(this.map.hasOwnProperty(f)){var g=a.find(f);if(g.length){var h={model:b},i=Nervenet.parseNamespace(this.map[f]);i?g.each(function(){h.el=this,c.push(e.$context.createInstance(i,h))}):this.loadMediatorClass(c,this.map[f],h,g)}}a.find("[data-mediator-class]").each(function(){var a=$(this).data("mediator-class"),d=Nervenet.parseNamespace(a),f={model:b};d?(f.el=this,c.push(e.$context.createInstance(d,f))):e.loadMediatorClass(c,a,f,$(this))})},clear:function(a){var b=a.find(".datetimepicker");b.destroy&&b.destroy();var c=a.data("components");if(c&&0!==c.length){for(var d=0,e=c.length;e>d;d++)c[d].remove();c.length=0}},find:function(a,b){var c=a.data("components");if(c){var d=[];b=Nervenet.parseNamespace(b);for(var e=0,f=c.length;f>e;e++)c[e]instanceof b&&d.push(c[e]);return d}},getPath:function(a){var b=a.split(".");return b[0]===tp.NAME_SPACE&&(b=b.slice(1)),"js/"+b.join("/")+".js"},loadMediatorClass:function(a,b,c,d){var e=this,f=document.createElement("script");f.async=!0,f.src=this.getPath(b),f.onload=function(){this.onload=null;var f=Nervenet.parseNamespace(b);if(!f)throw new Error("cannot find mediator");d.each(function(){c.el=this,a.push(e.$context.createInstance(f,c))})},document.head.appendChild(f)},preCheck:function(a){var b=a.data("components");if(!b)return!0;for(var c=0,d=b.length;d>c;c++)if("preCheck"in b[c]&&!b[c].preCheck())return!1;return!0}},a.spinner='<i class="fa fa-spin fa-spinner"></i>'}(Nervenet.createNameSpace("tp.component")),function(a){var b,c='<p><i class="fa fa-spinner fa-spin fa-4x"></i></p>';

a.Base=tp.view.DataSyncView.extend({$context:null,events:{"shown.bs.modal":"shownHandler","hidden.bs.modal":"hiddenHandler","loaded.bs.modal":"loadCompleteHandler","click .modal-footer .btn-primary":"submitButton_clickHandler","click [data-dismiss=modal]":"closeButton_clickHandler",keydown:"keydownHandler",success:"form_successHandler"},initialize:function(a){this.model=this.model||this.$context.getValue("model"),a.isRemote?(this.$el.addClass("loading").find(".modal-body").html(c),/\.hbs$/.test(a.content)?$.get(a.content,_.bind(this.template_loadedHandler,this)):(a.isMD=/\.md$/.test(a.content),$.get(a.content,_.bind(this.onLoadComplete,this))),ga("send","pageview",a.content)):this.onLoadComplete(a.content),this.options=a,this.$el.modal(a)},remove:function(){clearTimeout(b),this.options=null,this.off(),Backbone.View.prototype.remove.call(this)},hide:function(){var a=this.$el;b=setTimeout(function(){a.modal("hide")},3e3)},onLoadComplete:function(a){a&&(this.options&&this.options.isMD&&(a=marked(a)),this.$(".modal-body").html(a)),this.$el.removeClass("loading").find(".modal-footer .btn-primary").prop("disabled",!1),tp.component.Manager.check(this.$el,this.model)},closeButton_clickHandler:function(){this.$el.modal("hide"),this.trigger("cancel",this)},form_successHandler:function(){this.hide(),this.trigger("success")},submitButton_clickHandler:function(a){a.currentTarget.form||this.$el.modal("hide"),this.trigger("confirm",this)},template_loadedHandler:function(a){this.template=Handlebars.compile(a);var b=_.extend({API:tp.API},this.options,this.model?this.model.toJSON():null);this.onLoadComplete(this.template(b))},hiddenHandler:function(){this.remove(),this.trigger("hidden",this)},keydownHandler:function(a){13===a.keyCode&&a.ctrlKey&&(this.$(".modal-footer .btn-primary").submit(),a.preventDefault())},loadCompleteHandler:function(){this.onLoadComplete()},shownHandler:function(){this.$(".modal-footer .btn-primary").prop("disabled",!1)}})}(Nervenet.createNameSpace("tp.popup")),function(a){var b,c=a.Editor=tp.view.DataSyncView.extend({$context:null,form:null,events:{"hidden.bs.modal":"hiddenHandler",keydown:"keydownHandler","mousedown .input-group":"inputGroup_mouseDownHandler"},initialize:function(a){this.submit=this.$(".btn-primary"),this.options=a;var b=a.type||"short-text",c=a.template?"page/"+a.template:tp.path+"template/popup-"+b;$.get(c+".hbs",_.bind(this.loadCompleteHandler,this),"html");var d=$(".editor-info");d.length&&(d=Handlebars.compile(d.html()),this.$(".info").html(d(this.model.toJSON()))),this.$el.modal(a)},render:function(a){a=Handlebars.compile(a),this.$(".loading").remove(),this.form=new tp.component.SmartForm({tagName:"form",id:"prop-editor",className:"editor-form model-editor",model:this.model});var b=a(_.extend(this.model.toJSON(),this.options));this.form.$el.html(b).insertAfter(this.$(".alert-msg")),this.form.on("success",this.form_successHandler,this),this.form.on("error",this.form_errorHandler,this),b=this.$(".item-grid").html(),b&&(this.template=Handlebars.compile(b),this.$(".item-grid").empty());var c=this.$("[type=datetime]");c.length&&c.each(function(){$(this).datetimepicker($(this).data())}),this.submit.prop("disabled",!1)},hide:function(a){a=void 0===a?3e3:a;var c=this.$el;b=setTimeout(function(){c.modal("hide")},a)},form_errorHandler:function(a,b,c){this.displayResult(!1,c.message,"frown-o"),this.trigger("error",a,b,c)},form_successHandler:function(a){this.displayResult(!0,a.msg,"smile-o"),this.trigger("success",a),this.hide()},inputGroup_mouseDownHandler:function(a){$(a.currentTarget).find("[type=radio]").prop("checked",!0)},keydownHandler:function(a){13===a.keyCode&&a.ctrlKey&&(this.form.$el.submit(),a.preventDefault())},loadCompleteHandler:function(a){this.render(a)},hiddenHandler:function(){this.form.remove(),this.collection&&this.collection instanceof Backbone.Collection&&this.collection.off(null,null,this),clearTimeout(b),this.$el.remove(),this.trigger("hidden")}});a.SearchEditor=c.extend({fragment:"",events:_.extend(c.prototype.events,{"click .search-button":"searchButton_clickHandler"}),initialize:function(a){c.prototype.initialize.call(this,a),this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this)},render:function(a){c.prototype.render.call(this,a)},search:function(){var a=this.$("[type=search]").val();a&&(this.collection.fetch({data:{keyword:a}}),this.$("[type=search], .search-button").prop("disabled",!0))},collection_addHandler:function(a){this.fragment+=this.template(a.toJSON())},collection_syncHandler:function(){this.$(".search-result").html(this.fragment+"<hr />"),this.$("[type=search], .search-button").prop("disabled",!1),this.fragment=""},searchButton_clickHandler:function(){this.search()},keydownHandler:function(a){c.prototype.keydownHandler.call(this,a),13===a.keyCode&&"search"===a.target.type&&""!=a.target.value&&(this.search(),a.preventDefault())}}),a.TagsEditor=c.extend({events:_.extend(c.prototype.events,{"click .add-button":"addButton_clickHandler"}),initialize:function(a){c.prototype.initialize.call(this,a),this.collection.on("add",this.collection_addHandler,this)},render:function(a){if(c.prototype.render.call(this,a),this.options.tag&&this.collection){var b=this.options.tag;this.collection.map(function(a){a.set("tag",a.get(b))})}this.$(".item-grid").html(this.template({value:this.collection.toJSON()}))},add:function(){var a=this.$("[name=query]").val().replace(/^\s+|\s+$/,"");a&&!this.collection.find({tag:a})&&(this.$("[name=query], .add-button").prop("disabled",!0),this.$(".add-button i").addClass("fa-spin fa-spinner"),this.collection.create({tag:a},{wait:!0}))},addButton_clickHandler:function(){this.add()},collection_addHandler:function(a){var b=a.toJSON();b.index=this.collection.length-1,$(this.template({value:[b],append:!0})).insertBefore(this.$("hr")),this.$("[name=query],.add-button").prop("disabled",!1).val(""),this.$(".add-button i").removeClass("fa-spin fa-spinner")},keydownHandler:function(a){13===a.keyCode&&""!=a.target.value&&(this.add(),a.preventDefault())}}),a.SelectEditor=c.extend({render:function(a){if(this.options.options&&(this.model.options?this.options.options=this.model.options[this.options.options]:this.model.collection.options&&(this.options.options=this.model.collection.options[this.options.options])),c.prototype.render.call(this,a),this.options.addNew){{var b=new tp.model.ListCollection.getInstance({collectionId:this.options.prop,url:tp.API+this.options.url});new tp.component.CollectionSelect({el:this.$("select"),collection:b})}b.reset(this.options.options)}else this.options.list&&this.$("select").html($(this.options.list).html());this.$("select").val(this.options.value)}}),a.NumberEditor=c.extend({initialize:function(a){a.range="range"===a.type,a.type="number",c.prototype.initialize.call(this,a)}}),a.FileEditor=c.extend({events:_.extend({"click [data-dismiss]":"clickHandler"},c.prototype.events),initialize:function(a){a.isImage=/image\/\*/.test(a.accept),a.API=tp.API,a.multiple&&(a.items=_.isArray(a.value)?a.value:a.value.split(",")),a.backdrop="static",a.keyboard=!1,c.prototype.initialize.call(this,a)},render:function(a){c.prototype.render.call(this,a),this.form.initUploader()},clickHandler:function(a){var b="您有文件正在上传，关闭窗口将导致上传失败。您确认要继续关闭窗口么？";this.form.$el.hasClass("loading")&&!confirm(b)&&a.stopPropagation()}}),a.SwitchEditor=c.extend({initialize:function(a){a.value=this.model.get(a.prop)!=a.open,c.prototype.initialize.call(this,a)}}),a.CheckboxEditor=c.extend({render:function(a){this.options.options&&(this.options.options=this.model.options?this.model.options[this.options.options]:this.model.collection.options[this.options.options]),c.prototype.render.call(this,a)}})}(Nervenet.createNameSpace("tp.popup")),function(a){a.Loader=Backbone.View.extend({$context:null,fresh:!1,tagName:"div",events:{"click .edit":"edit_clickHandler"},initialize:function(a){this.model instanceof Backbone.Model&&!a.hasData?(this.model.once("sync",this.model_syncHandler,this),this.model.fetch()):this.isModelReady=!0,$.get(a.template,_.bind(this.template_getHandler,this),"html"),"fresh"in a&&(this.fresh=a.fresh)},render:function(){this.$el.html(this.template(this.model instanceof Backbone.Model?this.model.toJSON():this.model)),this.fresh&&(this.fresh=!1,this.model.on("change",this.model_changeHandler,this));var a=this,b=this.$el,c=this.model;setTimeout(function(){tp.component.Manager.check(b,c),a.trigger("complete")},0)},edit_clickHandler:function(a){var b=$(a.currentTarget),c=b.data(),d=a.currentTarget.hash.substr(1);c.label=c.label||b.closest("td").prev("th").text(),this.$context.trigger("edit-model",this.model,d,c),a.preventDefault()},model_changeHandler:function(){var a=this.$(".active").filter(".tab-pane").attr("id");tp.component.Manager.clear(this.$el),this.render(),a&&this.$("[href=#"+a+"][data-toggle]").click()},model_syncHandler:function(){return this.template?this.render():void(this.isModelReady=!0)},template_getHandler:function(a){this.template=Handlebars.compile(a),this.isModelReady&&this.render()}})}(Nervenet.createNameSpace("tp.view")),function(a){a.Body=Backbone.View.extend({$context:null,events:{"click .add-button":"addButton_clickHandler","click .refresh-button":"refreshButton_clickHandler"},initialize:function(){this.framework=this.$(".framework"),this.container=this.$("#page-container"),this.loading=this.$("#page-loading").remove().removeClass("hide"),this.loadCompleteHandler=_.bind(this.loadCompleteHandler,this),this.model.on("change:fullname",this.model_nameChangeHandler,this),this.$el.popover({selector:"[data-toggle=popover]"})},clear:function(){this.$context.removeValue("model"),tp.component.Manager.clear(this.container),this.page&&(this.page.remove(),this.page=null)},createSidebar:function(){this.template=this.template||Handlebars.compile(this.$("#navbar-side-inner").find("script").remove().html()),this.$(".sidebar-nav-item").remove();var a=this.model.get("sidebar")?this.model.get("sidebar"):"default",b=this.template;$.getJSON("page/sidebar/"+a+".json",function(a){var c=b({list:a});$("#navbar-side-inner").append(c)})},load:function(a,b,c){if(c=c||{},this.clear(),this.$el.toggleClass("full-page",!!c.isFull).removeClass(this.lastClass),$("#navbar-side").removeClass("in"),/.hbs$/.test(a)){var d=c.loader||tp.view.Loader,e=this.page=this.$context.createInstance(d,_.extend({template:a,model:b},c));this.container.html(e.$el),e.once("complete",this.page_loadCompleteHandler,this)}else this.container.load(a,this.loadCompleteHandler);return this.container.append(this.loading),this.trigger("load:start",a),ga("send","pageview",a),this},setFramework:function(a,b,c,d){return this.$el.addClass(a),this.lastClass=a,d instanceof Backbone.Model&&b?(d.once("sync",function(){this.setTitle(b,c,d)},this),this):this.setTitle(b,c,d)},setTitle:function(a,b,c){return c&&(c=c instanceof Backbone.Model?c.toJSON():c,a=Handlebars.compile(a)(c),b=Handlebars.compile(b)(c)),a+=b?" <small>"+b+"</small>":"",this.$("#content > .page-header > h1").html(a),this},start:function(a){this.isStart=!0,this.$("#page-preloader").remove(),a&&(this.createSidebar(),this.$el.removeClass("full-page").find(".login").remove())},addButton_clickHandler:function(a){var b=$(a.currentTarget).data();!b.title&&a.currentTarget.title&&(b.title=a.currentTarget.title),b.collectionId=a.currentTarget.hash.substr(1),this.$context.trigger("add-model",b),a.preventDefault()},model_nameChangeHandler:function(a,b){this.$(".username").html(b)},refreshButton_clickHandler:function(a){Backbone.history.loadUrl(Backbone.history.fragment),a.preventDefault()},page_loadCompleteHandler:function(){this.loading.remove()},loadCompleteHandler:function(a,b){"error"===b?this.trigger("load:failed"):tp.component.Manager.check(this.container),this.loading.remove(),this.trigger("load:complete")}})}(Nervenet.createNameSpace("tp.view")),function(a){var b="itms-apps://",c='{{#each list}}<option value="{{id}}">{{channel}} {{ad_name}} {{cid}}</option>{{/each}}',d=["ad_url","ad_lib","ad_size","id"];a.AdEditor=tp.view.Loader.extend({events:{"blur [name=ad_url]":"adURL_blurHandler","change [name=ad_name]":"adName_changeHandler","change [name=ad_app_type]":"platform_changeHandler","change [name=search_flag]":"searchFlag_changeHandler","change .ad-source-list":"adSource_changeHandler","change #replace-ad":"replaceAD_changeHandler","change .domestic input":"area_changeHandler","change .isp input":"isp_changeHandler","change #feedback":"feedback_changeHandler","change #app-uploader [name=ad_url]":"adURL_changeHandler","click .search-ad-button":"searchADButton_clickHandler","click .search-channel-button":"searchChannelButton_clickHandler","keydown .channel-keyword":"channelKeyword_keyDownHandler"},render:function(){tp.view.Loader.prototype.render.call(this),this.channels=tp.model.ListCollection.getInstance({collectionId:"channel",url:tp.API+"channel/",key:"channel"}),this.channels.options={channel_types:this.model.options.channel_types,relativeSales:this.model.options.relativeSales},this.channels.reset(this.model.options.channels),this.channels.on("reset",function(){this.$(".channel").find("input").prop("disabled",!1),this.$(".search-channel-button").spinner(!1)},this);var a=this.model.pick(_.keys(this.model.defaults)),b=this.$("form");setTimeout(function(){b.trigger("data",a)},50)},remove:function(){Backbone.View.prototype.remove.call(this),this.model.off(null,null,this),this.channels.off(),this.channels=null},checkADURL:function(a){return/\.ipa$/.test(a)||/itunes.apple.com/.test(a)?void this.$("input[name=ad_app_type][value=2]").prop("checked",!0):void(/\.apk$/.test(a)&&this.$("input[name=ad_app_type][value=1]").prop("checked",!0))},searchChannel:function(){var a=$.trim(this.$(".channel-keyword").val());return a?(this.$(".channel").find("input").prop("disabled",!0),this.$(".search-channel-button").spinner(),void this.channels.fetch({data:{keyword:a},reset:!0})):!1},adName_changeHandler:function(a){this.$(".search-ad-button").prop("disabled",!a.target.value)},adSource_changeHandler:function(a){var b=$(a.target).data("list"),c=_.omit(b[a.target.selectedIndex],d);this.$("form").trigger("data",c)},adURL_blurHandler:function(a){this.$el.hasClass("iPhone")&&a.target.value.substr(0,12)!==b&&(a.target.value=a.target.value.replace(/^https?:\/\//i,b))},adURL_changeHandler:function(a){this.checkADURL(a.target.value)},area_changeHandler:function(a){var b=$(a.target);this.$el.toggleClass(b.data("class"),"1"===b.val())},channelKeyword_keyDownHandler:function(a){13===a.keyCode&&(this.searchChannel(),a.preventDefault())},feedback_changeHandler:function(a){this.$el.toggleClass("show-feedback-detail","2"===a.target.value||"3"===a.target.value)},fetchAD_errorHandler:function(){alert("加载已有广告失败"),this.$("#replace-ad").prop("disabled",!1).next().removeClass("spin")},fetchAD_successHandler:function(a){var b=Handlebars.compile(c),e=b(a);this.hasAD=!0,this.$("[name=replace-with]").data("list",a.list).html(e),this.$("[name=replace-with],#replace-time,#replace-ad").prop("disabled",!1),this.$("#replace-ad").next().removeClass("spin"),this.$("form").trigger("data",_.omit(a.list[0],d))},isp_changeHandler:function(a){var b=$(a.target),c=a.target.value,d=a.target.checked;d?"0"===c?b.siblings().prop("checked",!1):b.siblings().first().prop("checked",!1):"0"===c?b.siblings().prop("checked",!0):0===b.siblings().filter(":checked").length&&b.siblings().first().prop("checked",!0)},platform_changeHandler:function(a){this.$("form").removeClass("Android iPhone").addClass(a.target.labels[0].innerText);var b="2"===a.target.value;this.$("#process_name").prop("required",b),$("#feedback").val(function(){return b?4:this.value}),$("#app-uploader").data("accept",b?"*.ipa":"*.apk")},replaceAD_changeHandler:function(a){var b=a.target.checked,c=this.model.get("pack_name")||this.$("[name=pack_name]").val();return b&&!c?(alert("包名未知，请先上传安装包，或填写包名"),void(a.target.checked=!1)):b&&!this.hasAD?(tp.service.Manager.call(tp.API+"ad/",{pack_name:c,status:0},{success:this.fetchAD_successHandler,error:this.fetchAD_errorHandler,context:this,method:"get"}),this.$("#replace-time").datetimepicker({format:"YYYY-MM-DD HH:mm"}),a.target.disabled=!0,void $(a.target).next().addClass("spin")):void this.$("[name=replace-with],#replace-time").prop("disabled",!b)},searchAD_errorHandler:function(){alert("未找到符合广告名的广告"),this.$(".search-ad-button").spinner(!1)},searchAD_successHandler:function(a){var b=Handlebars.compile(c),e=_.omit(a.list[0],d);this.$(".ad-list-container").slideDown().find("select").html(b(a)).data("list",a.list),this.$("form").trigger("data",e),this.$(".search-ad-button").spinner(!1)},searchADButton_clickHandler:function(){var a=this.$("[name=ad_name]").val();tp.service.Manager.call(tp.API+"ad_basic/",{ad_name:a},{success:this.searchAD_successHandler,error:this.searchAD_errorHandler,context:this,method:"get"}),this.$(".search-ad-button").spinner()},searchChannelButton_clickHandler:function(){this.searchChannel()},searchFlag_changeHandler:function(a){this.$(".aso").toggle("1"===a.target.value)}})}(Nervenet.createNameSpace("tp.page")),function(a){var b="YYYY-MM-DD";a.DateRange=tp.popup.Base.extend({events:_.extend(tp.popup.Base.prototype.events,{'dp.change input[name="start-date"]':"startDate_changeHandler",'dp.change input[name="end-date"]':"endDate_changeHandler"}),onLoadComplete:function(a){tp.popup.Base.prototype.onLoadComplete.call(this,a);var b=$('input[name="start-date"]');this.setMaxDate(b,moment())},startDate_changeHandler:function(a){var c=a.date,d=($('input[name="start-date"]'),$('input[name="end-date"]')),e=this.getDateFromStart(d.val(),c.format(b));d.val(e),this.setEndDateRange(c,c.clone().add(6,"days"))},endDate_changeHandler:function(a){var c=$('input[name="start-date"]'),d=($('input[name="end-date"]'),a.date),e=this.getDateFromEnd(c.val(),d.format(b));c.val(e),this.setEndDateRange(moment(e),moment(e).add(6,"days"))},setMinDate:function(a,b){a.data("DateTimePicker").minDate(b)},setMaxDate:function(a,b){a.data("DateTimePicker").maxDate(b)},setEndDateRange:function(a,b){var c=$('input[name="end-date"]');try{this.setMinDate(c,a),this.setMaxDate(c,b)}catch(d){this.setMaxDate(c,b),this.setMinDate(c,a)}},getDateFromEnd:function(a,c){var d=a,e=moment(a).add(6,"days").format(b);return c>=d&&e>=c?a:d>c?c:c>e?c:void 0},getDateFromStart:function(a,c){var d=moment(a).subtract(6,"days").format(b),e=a;return d>c?moment(c).add(6,"days").format(b):c>=d&&e>=c?a:c>e?moment(c).add(6,"days").format(b):void 0}})}(Nervenet.createNameSpace("tp.page")),function(a){a.AddOnList=a.BaseList.extend({initialize:function(b){b=_.extend({container:"tbody"},b),this.collection=new Backbone.Collection,a.BaseList.prototype.initialize.call(this,b);var c=this.$el.data("collection-id"),d=this.$el.data("key"),e=tp.model.ListCollection.getInstance({collectionId:c});e.on("data:"+d,this.collection_dataHandler,this)},collection_dataHandler:function(a){this.collection.reset(a)}})}(Nervenet.createNameSpace("tp.component")),function(a){a.LoginForm=Backbone.View.extend({events:{"click #verify-code":"verifyCode_clickHandler"},verifyCode_clickHandler:function(a){var b=a.target.src,c=b.indexOf("?ts="),d=Date.now();b=-1===c?b+"?ts="+d:b.replace(/\?ts=\d+$/,"?ts="+d),a.target.src=b}})}(Nervenet.createNameSpace("tp.component")),function(a){a.MorrisChart=Backbone.View.extend({$colors:null,initialize:function(a){if(a.data)return this.createOptions(a),void this.drawChart();var b=this.$el.data();if(a=_.extend({autoFetch:!0},a,b),a.url)return this.collection=tp.model.ListCollection.getInstance(a),this.createOptions(a),void(a.autoFetch?(this.collection.once("sync reset",this.collection_fetchHandler,this),this.collection.fetch()):this.collection_fetchHandler());var c=this.$("script");if(c.length){var d=JSON.parse(c.remove().html().replace(/,\s?]/,"]"));if(d.data.length)return this.createOptions(a,d),void this.drawChart()}this.showEmpty()},createOptions:function(a,b){a=_.extend({element:this.el,lineWidth:2},a,b),this.className="type"in a?a.type.charAt(0).toUpperCase()+a.type.substr(1):"Line",a.colors=a.lineColors=a.barColors="colors"in a?_.isArray(a.colors)?a.colors:a.colors.split(","):this.$colors,"Donut"===this.className&&(a.formatter=function(a,b){return"percent"in b?a+"("+b.percent+"%)":a}),_.isArray(a.ykeys)||(a.ykeys=[a.ykeys]),_.isArray(a.labels)||(a.labels=[a.labels]),this.options=a},drawChart:function(){this.$(".fa-spin").remove(),this.chart=new Morris[this.className](this.options)},showEmpty:function(){this.$el.addClass("empty").text("（无数据）")},collection_fetchHandler:function(){0===this.collection.length&&this.showEmpty(),this.options.data=this.collection.toJSON(),this.drawChart()}})}(Nervenet.createNameSpace("tp.component")),function(a){var b=Handlebars.compile('<a href="#/{{key}}/{{value}}" class="filter label label-{{key}}">{{value}}</a>');a.SmartTable=a.BaseList.extend({$context:null,events:{"click .add-row-button":"addRowButton_clickHandler","click .archive-button":"archiveButton_clickHandler","click .delete-button":"deleteButton_clickHandler","click .edit":"edit_clickHandler","click tbody .filter":"tbodyFilter_clickHandler","click thead .filter":"theadFilter_clickHandler","click .order":"order_clickHandler","change select.edit":"select_changeHandler","change .stars input":"star_changeHandler","change .status-button":"statusButton_changeHandler"},initialize:function(b){var c=this.$el.data();if(c.url=c.url.replace("{{API}}",tp.API),b=_.extend({autoFetch:!0},b,c),b.model=c.model?Nervenet.parseNamespace(c.model):null,this.params=tp.utils.decodeURLParam(c.params),(b.start||b.end)&&(b.defaults=_.pick(b,"start","end")),this.collection=tp.model.ListCollection.getInstance(b),a.BaseList.prototype.initialize.call(this,{container:"tbody"}),this.model=this.model&&this.model instanceof tp.model.TableMemento?this.model:new tp.model.TableMemento,this.model.on("change",this.model_changeHandler,this),this.model.on("invalid",this.model_invalidHandler,this),this.renderHeader(),"search"in c&&(this.search=new a.table.Search({el:c.search,model:this.model,collection:this.collection})),"pagesize"in c&&c.pagesize>0&&(this.pagination=new a.table.Pager(_.extend({},b,{el:"pagination"in c?c.pagination:".pager",model:this.model,collection:this.collection}))),"pagesizeController"in c&&(this.pagesizeController=$(c.pagesizeController),this.pagesizeController.val(this.collection.pagesize),this.pagesizeController.on("change",_.bind(this.pagesize_changeHandler,this))),"ranger"in c&&(this.ranger=new a.table.Ranger(_.extend({},b,{el:c.ranger,model:this.model}))),"filter"in c&&(this.filter=new a.table.Filter({el:c.filter,model:this.model,collection:this.collection})),b.autoFetch){var b=this.collection.length?{reset:!0}:null;this.collection.fetch({data:_.extend(this.model.toJSON(),this.params)},b)}},remove:function(){this.pagination&&this.pagination.remove(),this.pagesizeController&&this.pagesizeController.off("change"),this.ranger&&this.ranger.remove(),this.filter&&this.filter.remove(),this.model.off(null,null,this),this.collection.off(null,null,this),tp.model.ListCollection.destroyInstance(this.$el.data("collection-id")),a.BaseList.prototype.remove.call(this)},render:function(){if(a.BaseList.prototype.render.call(this),this.$context.trigger("table-rendered",this),"order"in this.model.changed||"seq"in this.model.changed){var b=this.container;this.collection.each(function(a){b.append(b.find("#"+a.id))})}},renderHeader:function(){var a=this.model.get("order"),c=this.model.get("seq"),d=this.model.omit("keyword","order","seq"),e="";a&&(this.$(".order").removeClass("active inverse"),this.$(".order[href=#"+a+"]").addClass("active").toggleClass("inverse","desc"==c)),_.each(d,function(a,c){e+=b({key:c,value:a})}),this.$(".filters").append(e)},saveModel:function(a,b,c,d,e){a.spinner(),this.collection.get(b).save(c,d,{patch:!0,wait:!0,context:this,success:function(){a.spinner(!1),e&&e.remove&&this.collection.remove(b,{fadeOut:!0})}})},addRowButton_clickHandler:function(a){var b=$(a.currentTarget).data("prepend");this.collection.add(null,{immediately:!0,prepend:!!b})},archiveButton_clickHandler:function(a){var b=$(a.currentTarget),c=b.data("msg")||"确定归档么？";if(confirm(c)){var d=b.closest("tr").attr("id");this.saveModel(b,d,b.attr("name"),b.val(),{remove:!0})}},collection_syncHandler:function(){a.BaseList.prototype.collection_syncHandler.call(this),this.model.waiting=!1},deleteButton_clickHandler:function(a){var b=$(a.currentTarget),c=b.data("msg")||"确定删除么？";if(confirm(c)){var d=b.closest("tr").attr("id");b.spinner(),this.collection.get(d).destroy({fadeOut:!0,wait:!0,error:function(a,c){var d="responseJSON"in c?c.responseJSON:c;b.spinner(!1),alert(d.msg||"删除失败")}}),a.preventDefault()}},edit_clickHandler:function(a){if("select"!==a.currentTarget.tagName.toLowerCase()){var b=$(a.currentTarget),c=b.data(),d=b.closest("td").index(),e=a.currentTarget.hash.substr(1),f=b.closest("tr").attr("id"),g=this.collection.get(f),h=_.extend({label:this.$("thead th").eq(d).text()},c);h.type=c.type||"short-text",this.$context.trigger("edit-model",g,e,h),a.stopPropagation(),a.preventDefault()}},model_changeHandler:function(a,b){b=_.omit(b,"unset")||{},b.data=_.extend(a.toJSON(),this.params),_.extend(this.collection.model.prototype.defaults,_.pick(a.changed,"start","end")),this.collection.fetch(b),this.$el.addClass("loading"),a.warting=!0},model_invalidHandler:function(a,b){alert(b)},order_clickHandler:function(a){var b=$(a.currentTarget),c=b.attr("href").substr(1);this.$(".order.active").not(b).removeClass("active inverse"),b.toggleClass("inverse",b.hasClass("active")&&!b.hasClass("inverse")).addClass("active"),this.model.set({order:c,seq:b.hasClass("inverse")?"desc":"asc"}),a.preventDefault()},pagesize_changeHandler:function(a){this.collection.setPagesize(a.target.value),this.collection.fetch({data:_.extend(this.model.toJSON(),this.params)})},select_changeHandler:function(a){var b=$(a.currentTarget),c=b.closest("tr").attr("id");this.saveModel(b,c,b.attr("name"),b.val())},star_changeHandler:function(a){var b=$(a.currentTarget),c=b.closest("tr").attr("id");this.saveModel(b.add(b.siblings(".star")),c,b.attr("name"),b.val())},statusButton_changeHandler:function(a){var b=$(a.currentTarget),c=_.extend({active:1,deactive:0},b.data()),d=b.prop("checked")?c.active:c.deactive,e=b.closest("tr").attr("id");this.saveModel(b,e,b.attr("name"),d)},tbodyFilter_clickHandler:function(a){var b=$(a.currentTarget),c=b.attr("href").split("/").slice(-2),d=this.model.has(c[0]);this.model.set(c[0],c[1]),d?this.$(".filters").find('[href="#/'+c[0]+'"]').replaceWith(b.clone()):this.$(".filters").append(b.clone()),a.preventDefault()},theadFilter_clickHandler:function(a){var b=$(a.currentTarget),c=b.attr("href").split("/").slice(-2);this.model.unset(c[0]),b.remove(),a.preventDefault()}})}(Nervenet.createNameSpace("tp.component"))}();