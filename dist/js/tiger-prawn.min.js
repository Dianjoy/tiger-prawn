/*! tiger-prawn Version 0.2.0
 2015-05-11 */
"use strict";!function(){!function(a){var b=a.sync;a.sync=function(a,c,d){return d=d||{},"xhrField"in d?d.xhrFields.withCredentials=!0:d.xhrFields={withCredentials:!0},b(a,c,d)},a.Model.prototype.isNew=function(){return!this.id}}(Backbone),function(a){var b=Array.prototype.slice,c=Array.prototype.pop;a.registerHelper("pick",function(a,c,d){if(a=parseInt(a),c=_.isArray(c)?c:b.call(arguments,1,-1),_.isArray(c)&&_.isObject(c[0])){for(var e,f=d.hash.key||"id",g=d.hash.label||"label",h=0,i=c.length;i>h;h++)if(c[h][f]==a){e=c[h];break}return e?e[g]:""}return c[a]}),a.registerHelper("substring",function(a,b,c){return a?a.substr(b,c):""}),a.registerHelper("text-collapse",function(a,b){return a?a.length<b?a:'<abbr title="'+a+'">'+a.substr(0,b)+"...</abbr>":""}),a.registerHelper("ext",function(a){return a?a.substr(a.lastIndexOf(".")+1):""}),a.registerHelper("d100",function(a){return(a/100).toFixed(2)}),a.registerHelper("moment",function(a){return a?moment(a).calendar():""}),a.registerHelper("from-now",function(a){return a?moment(a).fromNow():""}),a.registerHelper("equal",function(a,b,c){return a==b?c.fn(this):c.inverse(this)}),a.registerHelper("in",function(a,d,e){return _.isArray(d)||(e=c.call(arguments),d=b.call(arguments,1)),-1!==d.indexOf(a)?e.fn(this):e.inverse(this)}),a.registerHelper("raw-helper",function(a){return a.fn()})}(Handlebars),function(){var a={};try{localStorage.setItem("tp",1),localStorage.removeItem("tp")}catch(b){localStorage.setItem=function(b,c){a[b]=c},localStorage.getItem=function(b){return a[b]}}}(),function(a){a.Base=Backbone.Router.extend({$body:null,$me:null,routes:{"user/:page":"showUserPage",dashboard:"showDashboard"},showDashboard:function(){this.$body.load(tp.path+"page/dashboard.hbs",new tp.model.Dashboard)},showUserPage:function(a){return"logout"===a?this.$me.destroy({success:function(a){a.clear(),location.hash="#/user/login"}}):(tp.config.login.api=this.$me.url,this.$body.load(tp.path+"page/"+a+".hbs",tp.config.login,{isFull:!0}),void this.$body.setFramework("login"))}})}(Nervenet.createNameSpace("tp.router")),function(a){var b={$body:null,$me:null,call:function(a,b,c){c=c||{};var d=this,e=c.success||this.onSuccess,f=c.error||this.onError,g=c.context;$.ajax({url:a,data:b,dataType:"json",type:c.method||"post",cache:!1,xhrFields:{withCredentials:!0},success:function(a){0===a.code?(e.call(g,a),d.postHandle(a),d.trigger("complete:call",a)):f.call(g,a)},error:function(a,b,c){f.call(g,a,b,c)}})},postHandle:function(a){"me"in a&&this.$me.set(a.me)},onError:function(a,b,c){401===b&&this.$body.load("page/error.html")},onProgress:function(a,b){},onSuccess:function(a){this.trigger("complete:upload",a)}};b=_.extend(b,Backbone.Events),a.Manager=b}(Nervenet.createNameSpace("tp.service")),function(a){{var b,c=Backbone.View.extend({$context:null,events:{"click .popup":"popupButton_clickHandler"},initialize:function(){this.template=Handlebars.compile(this.$("#popup").remove().html()),this.editor=Handlebars.compile(this.$("#editor-popup").remove().html())},postConstruct:function(){b&&this.$context.inject(b)},popup:function(b){var c=$(this.template(b));return this.$el.append(c),c=this.$context.createInstance(a.Base,_.extend({el:c},b))},popupEditor:function(a){var b=a.el=$(this.editor(a));return this.$el.append(b),b=d.createEditor(this.$context,a)},popupButton_clickHandler:function(a){var b=a.currentTarget,c=$(b).data();if(c.collectionId){var d=tp.model.ListCollection.getInstance(c);c.model=d.get(c.id)}"a"===b.tagName.toLowerCase()&&(c.content=b.href,c.isRemote=!0,c.title=c.title||b.title),this.popup(c),a.preventDefault()}}),d={createEditor:function(b,c){var d;switch(c.type){case"file":d=b.createInstance(a.FileEditor,c);break;case"number":case"range":d=b.createInstance(a.NumberEditor,c);break;case"search":d=b.createInstance(a.SearchEditor,c);break;case"select":d=b.createInstance(a.SelectEditor,c);break;case"tags":d=b.createInstance(a.TagsEditor,c);break;case"status":d=b.createInstance(a.SwitchEditor,c);break;case"checkbox":d=b.createInstance(a.CheckboxEditor,c);break;default:d=b.createInstance(a.Editor,c)}return d}};a.Manager=new c({el:"body"})}}(Nervenet.createNameSpace("tp.popup")),function(a){a.decodeURLParam=function(a){if(!a)return{};for(var b=a.split("&"),c={},d=0,e=b.length;e>d;d++){var f=b[d].split("=");c[f[0]]=decodeURIComponent(f[1])}return c}}(Nervenet.createNameSpace("tp.utils")),function(a){a.Error={getAjaxMessage:function(a,b,c){if("500"===a.statusCode().status)return{message:"服务器错误，请告知管理员",icon:"close"};if(0===a.status)return{message:"连接超时，请检查您的网络。",icon:"close"};var d=(a.responseJSON?a.responseJSON.msg:null)||c||"",e="frown-o";return"error"!==b||a.responseText||(d="请求服务器失败，请重试。若连续失败，请联系管理员。",e="user-md"),{message:d,icon:e}}}}(Nervenet.createNameSpace("tp")),function(a){function b(a,b,c){c.model=a,c.prop=b,tp.popup.Manager.popupEditor(c)}a.editModelCommand=function(a,c,d){d=_.extend({},d),d.value=a.get(c),b(a,c,d)}}(Nervenet.createNameSpace("tp.controller")),function(a){a.addModelCommand=function(a){var b=tp.model.ListCollection.getInstance(a),c=new b.model(null,a);a.isRemote=!0,a.content="page/"+a.template,c.options=b.options,c.urlRoot=b.url,a.model=c;var d=tp.popup.Manager.popup(a);d.on("success",function(){b.add(c,{immediately:!0,prepend:!0})})}}(Nervenet.createNameSpace("tp.controller")),function(a){var b="ad_owner",c="您刚刚上传的包和之前的报名不同，可能有误。您确定要保存么？";a.AD=Backbone.Model.extend({defaults:{ad_app_type:1,ad_type:0,cate:0,cpc_cpa:"cpa",put_net:0,province_type:0,put_jb:0,put_ipad:0,net_type:0,down_type:0,feedback:2,cycle:2},urlRoot:tp.API+"ad/",initialize:function(){this.isNew()&&(this.isEmpty=!0,this.urlRoot+="init",this.on("sync",this.syncHandler,this))},parse:function(a){a.options&&(this.options=a.options,this.options.API=tp.API,this.options.UPLOAD=tp.UPLOAD);var c=a.ad&&_.isObject(a.ad);return c&&!a.ad.owner&&(a.ad.owner=Number(localStorage.getItem(b))),c?a.ad:a},save:function(a,c,d){return"owner"===a&&c&&localStorage.setItem(b,c),a.owner&&localStorage.setItem(b,a.owner),Backbone.Model.prototype.save.call(this,a,c,d)},toJSON:function(a){var b=Backbone.Model.prototype.toJSON.call(this,a);if(a)return b;var c=this.previousAttributes();return _.isEmpty(c)||(b.previous=c),_.extend(b,this.options)},validate:function(a){var b=this.get("pack_name");return b&&a.pack_name!==b&&!confirm(c)?"新包名与之前不一致，请检查后重新上传。":void 0},syncHandler:function(){"id"in this.changed&&(location.hash="#/ad/"+this.id,this.urlRoot=tp.API+"ad/")}})}(Nervenet.createNameSpace("tp.model")),function(a){a.Dashboard=Backbone.Model.extend({className:"dashboard",url:tp.API+"dashboard/",parse:function(a){return"record"in a.data&&_.each(a.data.record,function(a){a.is_checked=a.status<2}),a.data}})}(Nervenet.createNameSpace("tp.model")),function(a){a.Me=Backbone.Model.extend({$body:null,url:tp.API+"user/",initialize:function(){this.on("change:id",this.id_changeHandler,this)},fetch:function(a){Backbone.Model.prototype.fetch.call(this,_.extend({error:_.bind(this.onError,this)},a))},parse:function(a){return a.me},id_changeHandler:function(a,b){if(b){this.$body.start(!0),tp.notification.Manager.start();var c;Backbone.History.started||(c=Backbone.history.start({root:"/tiger-prawn/"})),(!c||/^#\/user\/\w+$/.test(location.hash))&&(location.hash="#/dashboard")}else if(this.$body.isStart&&"#/user/logout"!==location.hash){var d=tp.config.login;d.welcome="登录已失效，请重新登录",d.api=this.url,tp.popup.Manager.popup(_.extend({title:"登录",content:"page/login.hbs",confirm:"登录",cancel:"退出",isRemote:!0},d))}else location.hash="#/user/login"},onError:function(){this.$body.start(),location.hash="#/user/login",Backbone.history.start({root:"/tiger-prawn"})}})}(Nervenet.createNameSpace("tp.model")),function(a){var b={},c=Backbone.Model.extend({parse:function(a){return"code"in a&&"msg"in a&&"data"in a?a.data:a},toJSON:function(a){var b=Backbone.Model.prototype.toJSON.call(this,a);if(a)return b;var c=this.previousAttributes();return _.isEmpty(c)||(b.previous=c),_.extend(b,this.options)}}),d=a.ListCollection=Backbone.Collection.extend({total:0,pagesize:10,isLoading:!1,initialize:function(a,b){if(this.key=tp.PROJECT+location.hash+"-pagesize",Backbone.Collection.prototype.initialize.call(this,a,b),b){b.url&&(this.url=b.url);var c=localStorage.getItem(this.key);this.pagesize=c||b.pagesize||this.pagesize}},fetch:function(a){this.isLoading||(a.data?a.data.pagesize=this.pagesize:a.data={pagesize:this.pagesize},Backbone.Collection.prototype.fetch.call(this,a),this.isLoading=!0)},parse:function(a){return this.isLoading=!1,this.total=_.isArray(a)?a.length:a.total,a.options&&(this.options=a.options),_.isArray(a)?a:a.list},setPagesize:function(a){this.pagesize=a,localStorage.setItem(this.key,a)}});d.getInstance=function(a){if(a.collectionId&&a.collectionId in b)return b[a.collectionId];var e=_.extend({},a);a.model&&a.model instanceof Function||(e.model="idAttribute"in a?c.extend({idAttribute:a.idAttribute}):c);var f=new d(null,e);return a.collectionId&&(b[a.collectionId]=f),f},d.destroyInstance=function(a){a in b&&delete b[a]}}(Nervenet.createNameSpace("tp.model")),function(a){var b=6e4,c=!1;a.Notice=Backbone.Collection.extend({latest:0,url:tp.API+"notice/",initialize:function(){this.on("sync",this.syncHandler,this),this.fetch=_.bind(this.fetch,this)},fetch:function(a){c=!0,a=_.extend({data:{latest:this.latest},remove:!1},a),Backbone.Collection.prototype.fetch.call(this,a)},parse:function(a){for(var b=0,c=a.list.length;c>b;b++)a.list[b].create_time=a.list[b].create_time.substr(5,11),this.latest=a.list[b].id>this.latest?a.list[b].id:this.latest;return a.list},stop:function(){c=!1,clearTimeout(b)},syncHandler:function(){c&&setTimeout(this.fetch,b)}})}(Nervenet.createNameSpace("tp.model")),function(a){a.TableMemento=Backbone.Model.extend({waiting:!1,initialize:function(){this.key=tp.PROJECT+location.hash;var a=localStorage.getItem(this.key);a&&(a=JSON.parse(a),this.set(a,{silent:!0})),this.on("change",this.changeHandler,this)},_validate:function(a,b){return"validate"in b||(b.validate=!0),Backbone.Model.prototype._validate.call(this,a,b)},validate:function(a,b){return this.waiting||"ignore"in b&&!b.ignore?"表格正在更新数据，请稍候。":void 0},changeHandler:function(){localStorage.setItem(this.key,JSON.stringify(this.omit("page","keyword")))}})}(Nervenet.createNameSpace("tp.model")),function(a){a.DataSyncView=Backbone.View.extend({displayProcessing:function(){this.$el.addClass("processing"),this.submit.prop("disabled",!0).find("i").hide().end().prepend('<i class="fa fa-spin fa-spinner"></i>')},displayResult:function(a,b,c){b=(c?'<i class="fa fa-'+c+'"></i> ':"")+b,this.submit.prop("disabled",!1).find("i:hidden").show().end().find(".fa-spin").remove(),this.$el.removeClass("processing"),this.$(".alert-msg").hide().toggleClass("alert-danger",!a).toggleClass("alert-success",a).html(b+" ("+moment().format("HH:mm:ss")+")").slideDown()}})}(Nervenet.createNameSpace("tp.view")),function(a){a.Panel=tp.view.DataSyncView.extend({fragment:"",events:{"click input":"input_clickHandler","click .mark-all-button":"markAllButton_clickHandler","change [name=check]":"check_changeHandler",animationend:"animationEndHandler",webkitAnimationEnd:"animationEndHandler"},initialize:function(){this.template=Handlebars.compile(this.$("script").remove().html()),this.header=this.$(".dropdown-header"),this.button=this.$(".dropdown-toggle"),this.submit=this.$(".mark-all-button"),this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this),this.collection.on("remove",this.collection_removeHandler,this)},refreshNumber:function(){var a=this.$("input:not(:checked)").length;this.label&&this.label.remove(),0!==a&&(this.label=$("<span>"+(a>10?"10+":a)+"</span>").appendTo(this.button),this.button.find("i").addClass("animated swing"))},animationEndHandler:function(a){$(a.target).removeClass("animated swing")},check_changeHandler:function(a){var b=a.target.value;this.collection.get(b).destroy()},collection_addHandler:function(a){this.fragment+=this.template(a.toJSON())},collection_removeHandler:function(a){var b=this.$("#msg-"+a.id);this.refreshNumber(),setTimeout(function(){b.fadeOut(function(){$(this).remove()})},3e3)},collection_syncHandler:function(){this.fragment&&(this.header.after(this.fragment),this.refreshNumber(),this.fragment="")},input_clickHandler:function(a){a.stopPropagation()},markAll_errorHandler:function(a,b){this.displayResult(!1,b,"times")},markAll_successHandler:function(a){this.$(".alarm").remove(),this.label.remove(),this.displayResult(!0,a.msg,"check"),this.$(".alert").delay(3e3).slideUp()},markAllButton_clickHandler:function(a){var b=[];this.collection.each(function(a){b.push(a.id)}),this.collection.sync("delete",this,{url:this.collection.url+b.join(","),success:this.markAll_successHandler,error:this.markAll_errorHandler,context:this}),this.displayProcessing(),a.stopPropagation()}})}(Nervenet.createNameSpace("tp.notification")),function(a){a.Growl=Backbone.View.extend({count:0,fragment:[],initialize:function(){this.template=Handlebars.compile(this.$("script").remove().html()),this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this)},collection_addHandler:function(a){return this.count>2?void this.count++:(this.fragment.push(this.template(a.toJSON())),void this.count++)},collection_syncHandler:function(){this.fragment&&(this.count>3&&(this.fragment[2]=this.template({number:this.count-2})),this.$el.append(this.fragment.join("")),this.fragment=[])}})}(Nervenet.createNameSpace("tp.notification")),function(a){function b(){this.permission="",this.requestPermission=function(){}}var c,d="Notification"in window?Notification:new b;"hidden"in document?c="hidden":"webkitHidden"in document?c="webkitHidden":"mozHidden"in document?c="mozHidden":"msHidden"in document&&(c="msHidden");{var e=Backbone.View.extend({count:0,initialize:function(){"granted"!==d.permission&&d.requestPermission(),this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this)},createDesktopNotice:function(){document[c]&&"granted"===d.permission&&new d("点乐自助平台通知",{icon:"img/fav.png",body:"收到"+this.count+"条通知，请及时处理哟。"})},start:function(){this.collection.fetch()},stop:function(){this.collection.stop()},collection_addHandler:function(){this.count++},collection_syncHandler:function(){this.count>0&&(this.createDesktopNotice(this.count),this.count=0)}}),f=new tp.model.Notice;new a.Panel({el:".system-notice",collection:f}),new a.Growl({el:"#growl",collection:f})}a.Manager=new e({collection:f})}(Nervenet.createNameSpace("tp.notification")),function(a){function b(a,b){if(0!==b.length){b=_.isArray(b)?b:[b];var c=b.join("<br />");$(a).popover({trigger:"manual",title:"表单填写有误",content:c,html:!0}).popover("show").one("focus",function(){$(this).off(".popover").removeData("popover").siblings(".popover").remove().end().closest(".form-group").removeClass("error")}).closest(".form-group").addClass("error")}}a.SmartForm=tp.view.DataSyncView.extend({$router:null,uploaders:[],events:{"blur input,textarea,select":"input_blurHandler","focus input":"input_focusHandler",submit:"submitHandler",data:"dataHandler","click .collapsible legend":"legend_clickHandler"},initialize:function(){this.submit=this.getSubmit(),this.model instanceof Backbone.Model&&this.model.on("invalid",this.model_invalidHandler,this),this.initUploader()},remove:function(){this.model.off(null,null,this),_.each(this.uploaders,function(a){a.off("data"),a.remove&&a.remove()}),this.uploaders=null,Backbone.View.prototype.remove.call(this)},validate:function(){var a=this.el.elements;return this.$el.hasClass("uploading")?(alert("上传文件中，请稍候"),!1):"newpassword"in a&&a.newpassword.value!==a.repassword.value?(b(a.repassword,"两次密码不一致哟，麻烦检查下吧"),!1):"password"in a&&!/^[0-9a-zA-Z$!^#_@%&*.]{6,32}$/.test(a.password.value)?(b(a.password,"密码应为6~16个字符，请重新填写"),!1):!0},checkInput:function(a){if(a.prop("required")&&""===a.val())return"此项为必填项，您好像漏掉了哟";var b=a.attr("pattern");if(b&&""!==a.val()&&!new RegExp(b).test(a.val()))return"填写格式有误，麻烦您检查并重新填写";if(/number/i.test(a.attr("type"))&&(void 0!==a.attr("min")||void 0!==a.attr("max"))){var c=Number(a.val());if(isNaN(c))return"此项只能输入数字";if(void 0!==a.attr("min")&&c<a.attr("min")||void 0!==a.attr("max")&&c>a.attr("max"))return"数值超出规定范围"}return"password"!==a.attr("type")||/^[0-9a-zA-Z$!^#_@%&*.]{6,32}$/.test(a.val())?"":"密码应为6~16个字符，包含字母、数字、特殊符号等"},getSubmit:function(){var a="button:not([type=button]), input[type=submit]",b=this.$(a);if(0===b.length){var c=this.$el.attr("id");b=$(a).filter("[form="+c+"]")}return b},initUploader:function(){var a=this.model?this.model.id:null,b=this,c=this.uploaders;this.$(".uploader").each(function(){var d=$(this).data();a&&(d.data={id:a});var e=new meathill.SimpleUploader(this,d);e.on("start",b.uploader_startHandler,b),e.on("data",b.uploader_dataHandler,b),c.push(e)}),this.$(".fetcher").each(function(){var a=new tp.component.FileFetcher({el:this,model:b.model});a.on("start",b.uploader_startHandler,b),a.on("data",b.uploader_dataHandler,b),c.push(a)})},useData:function(a){for(var b in a){if(!a.hasOwnProperty(b))return;var c=a[b];if(_.isArray(c))this.$('[name="'+b+'[]"]').each(function(){this.checked=-1!==c.indexOf(this.value)});else{var d=this.$("[name= "+b+"]:not([type=radio])").val(c);try{d.length>0||this.$("[name="+b+"][value="+c+'], [name="'+b+'[]"][value='+c+"]").prop("checked",!0)}catch(e){}"hidden"===d.attr("type")&&d.trigger("change")}}},input_blurHandler:function(a){var b=$(a.currentTarget),c=this.checkInput(b);c&&(this.$("input").tooltip("destroy"),b.tooltip({title:c,placement:"bottom",trigger:"manual"}).tooltip("show"))},input_focusHandler:function(a){$(a.currentTarget).tooltip("destroy")},legend_clickHandler:function(a){$(a.currentTarget).toggleClass("collapsed")},model_invalidHandler:function(a,b){this.displayResult(!1,b,"times"),this.trigger("error",null,1,{message:b})},submit_successHandler:function(a){this.displayResult(!0,a.msg,"smile-o"),this.$el.trigger("success"),this.trigger("success",a)},submit_errorHandler:function(a,b,c){c=tp.Error.getAjaxMessage(a,b,c),this.displayResult(!1,c.message,c.icon),this.trigger("error",a,b,c)},uploader_dataHandler:function(a){this.$el.removeClass("uploading"),this.useData(a)},uploader_startHandler:function(){this.$el.addClass("uploading")},dataHandler:function(a,b){this.useData(b)},submitHandler:function(a){if(!this.$el.is(":hidden")){var b=this.el,c=b.action;if(this.$el.hasClass("fake")||this.$el.hasClass("loading"))return a.preventDefault(),!1;if(-1!==c.indexOf("#"))return c=c.substr(c.indexOf("#")),c=c.replace(/\/:(\w+)/g,function(a,c){return"/"+b.elements[c].value}),this.$router.navigate(c),!1;this.displayProcessing();var d=this.validate();if(this.$el.hasClass("ajax")&&d){var e=this.$el.serialize();return tp.service.Manager.call(c,e,{success:this.submit_successHandler,error:this.submit_errorHandler,context:this,method:this.$el.attr("method")}),!1}if(this.$el.hasClass("model-editor")&&d){var f={},g=this;return _.each(this.$el.serializeArray(),function(a){var b=a.name.replace("[]","");void 0!==f[b]?(_.isArray(f[b])||(f[b]=[f[b]]),f[b].push(a.value)):f[b]=a.value},this),this.$(".switch").each(function(){var a=!isNaN(parseInt(this.value)),b=a?Number(this.value):this.value;b=this.checked?b:!b,f[this.name]=a?Number(b):b}),this.model.save(f,{patch:!0,wait:!0,success:function(a,b){g.submit_successHandler(b)},error:function(a,b){g.submit_errorHandler(b)}}),!1}return d}}})}(Nervenet.createNameSpace("tp.component")),function(a){a.BaseList=Backbone.View.extend({initialize:function(a){this.template=Handlebars.compile(this.$("script").remove().html().replace(/\s{2,}|\n/g,"")),this.container=a.container?this.$(a.container):this.$el,this.collection.on("add",this.collection_addHandler,this),this.collection.on("change",this.collection_changeHandler,this),this.collection.on("remove",this.collection_removeHandler,this),this.collection.on("sync",this.collection_syncHandler,this),this.collection.on("reset",this.collection_resetHandler,this)},remove:function(){this.collection.off(null,null,this),Backbone.View.prototype.remove.call(this)},render:function(){this.$(".waiting").hide(),this.container.append(this.fragment),this.fragment="",this.$el.removeClass("loading")},collection_addHandler:function(a,b,c){if(this.fragment+=this.template(a.toJSON()),c&&c.immediately){var d=$(this.fragment);d.attr("id",a.id||a.cid),this.container[c.prepend?"prepend":"append"](d),this.fragment=""}},collection_changeHandler:function(a){var b=this.template(a.toJSON());this.$("#"+(a.id||a.cid)).replaceWith(b)},collection_removeHandler:function(a,b,c){var d=this.$("#"+(a.id||a.cid));c.fadeOut?d.fadeOut(function(){$(this).remove()}):d.remove()},collection_resetHandler:function(){this.container.empty(),this.collection.each(function(a){this.collection_addHandler(a)},this),this.render()},collection_syncHandler:function(){this.render()}})}(Nervenet.createNameSpace("tp.component")),function(a){a.FileFetcher=Backbone.View.extend({events:{"click .fetch-button":"fetchButton_clickHandler","change [name]":"input_changeHandler"},validate:function(a){var b=/^https?:\/\//;return b.test(a)},fetchButton_clickHandler:function(){var a=this.$("[name=ad_url]"),b=a.val();if(b&&"hidden"!==a.attr("type")){if(/itunes\.apple\.com/.test(b))return void alert("App Store应用暂时不支持抓取");tp.service.Manager.call(tp.API+"fetch/",{type:"ad_url",id:this.model.id,file:b},{context:this,success:this.fetchFile_successHandler,error:this.fetchFile_errorHandler}),this.$(".fetch-button").prop("disabled",!0).find("i").addClass("fa-spin fa-spinner"),this.$("[name=ad_url]").prop("disabled",!0)}},fetchFile_successHandler:function(a){alert("服务器抓取文件成功"),this.trigger("data",a.form),this.$(".fetch-button").prop("disabled",!1).find("i").removeClass("fa-spin fa-spinner"),this.$("[name=ad_url]").prop("disabled",!1)},fetchFile_errorHandler:function(a){alert(a.msg)},input_changeHandler:function(a){a.target.value=a.target.value.replace(/\s/g,"");var b=this.validate(a.target.value);this.$(".fetch-button").toggleClass("btn-warning",b).prop("disabled",!b)}})}(Nervenet.createNameSpace("tp.component")),function(a){var b="YYYY-MM-DD",c='<i class="fa fa-spin fa-spinner"></i>';a.Pager=Backbone.View.extend({events:{"click a":"clickHandler"},initialize:function(a){this.template=this.$("script").remove().html()||"",this.template=this.template?Handlebars.compile(this.template):!1,this.pagesize=this.collection.pagesize,this.total=Math.ceil(a.length/this.pagesize),this.render(),this.displayPageNum(),this.collection.on("sync",this.collection_syncHandler,this)},remove:function(){this.collection.off(null,null,this),this.model=this.collection=null,Backbone.View.prototype.remove.call(this)},render:function(){if(this.template){for(var a=this.model.get("page"),b=[],c=a-5>0?a-5:0,d=c+10<this.total?c+10:this.total,e=d-c,f=0;e>f;f++)b[f]={index:f+c,label:f+c+1};this.$el.html(this.template({pages:b,prev:a-1,next:a+1}))}},displayPageNum:function(){var a=this.model.get("page")||0,b=this.total;this.$('[href="#/to/'+a+'"]').closest(".hidden-xs").addClass("active").siblings().removeClass("active"),this.$el.each(function(){$(this).children().first().toggleClass("disabled",0===a).end().last().toggleClass("disabled",a>=b-1)})},setTotal:function(a,b){this.pagesize=b||this.pagesize,this.total=Math.ceil(a/this.pagesize),this.render(),this.displayPageNum()},collection_syncHandler:function(){this.setTotal(this.collection.total,this.collection.pagesize)},clickHandler:function(a){var b=$(a.currentTarget),d=b.parent();if(d.hasClass("disabled")||d.hasClass("active"))return!1;var e=b.attr("href"),f=Number(e.substr(e.lastIndexOf("/")+1));this.model.set("page",f),b.html(c),this.$el.children().addClass("disabled"),a.preventDefault()}}),a.Ranger=Backbone.View.extend({events:{"click .shortcut":"shortcut_clickHandler","click .range input":"input_clickHandler","click .range button":"range_clickHandler"},initialize:function(a){this.$("[type=date]").datetimepicker({format:b});var c=this.render(a);this.trigger(c,{silent:!0})},render:function(a){var c=_.extend({start:-31,end:0},_.pick(a,"start","end"));return c.start=moment().add(c.start,"days").format(b),c.end=moment().add(c.end,"days").format(b),this.$("[name=start]").val(c.start),this.$("[name=end]").val(c.end),c},remove:function(){return this.stopListening(),this.el=this.$el=this.model=null,this},trigger:function(a,b){b=b||{},b.reset=!0,this.model.set(a,b)},input_clickHandler:function(a){a.stopPropagation()},range_clickHandler:function(){var a=this.$("[name=start]").val(),b=this.$("[name=end]").val();this.$(".shortcut").removeClass("active"),this.$(".label").text(a+" - "+b),this.trigger({start:a,end:b})},shortcut_clickHandler:function(a){var b=$(a.currentTarget),c=b.data("start"),d=b.data("end");b.addClass("active").siblings().removeClass("active"),this.$(".label").text(b.text());var e=this.render({start:c,end:d});this.trigger(e),a.preventDefault()}}),a.Search=Backbone.View.extend({events:{keydown:"keydownHandler"},initialize:function(){this.$el.val(this.model.get("keyword")),this.collection.on("sync",this.collection_syncHandler,this)},remove:function(){this.collection.off(null,null,this),this.collection=this.model=null,Backbone.View.prototype.remove.call(this)},collection_syncHandler:function(){this.$el.prop("readonly",!1),this.spinner&&this.spinner.remove()},keydownHandler:function(a){13===a.keyCode&&(this.model.unset("keyword",{silent:!0}),this.model.set({keyword:a.target.value,page:0}),this.$el.prop("readonly",!0),this.spinner=this.spinner||$(c),this.spinner.insertAfter(this.$el))}}),a.Filter=Backbone.View.extend({events:{change:"changeHandler"},initialize:function(){this.model.on("change",this.model_changeHandler,this),this.collection.on("sync",this.collection_syncHandler,this),this.render()},render:function(){var a=this.model.toJSON();for(var b in a)this.$("[name="+b+"]").val(a[b])},remove:function(){this.collection.off(null,null,this),this.collection=this.model=null,Backbone.View.prototype.remove.call(this)},collection_syncHandler:function(){this.$(".fa-spin").remove(),this.$("select").prop("disabled",!1)},model_changeHandler:function(){this.$("select").prop("disabled",!0)},changeHandler:function(a){var b=a.target,d=b.name,e=b.value;this.model.set(d,e,{reset:!0}),$(b).after(c)}})}(Nervenet.createNameSpace("tp.component.table")),function(a){a.Manager={$context:null,map:{".smart-table":"tp.component.SmartTable",".smart-navbar":"tp.component.SmartNavbar",".smart-info":"dianjoy.component.SmartInfo",".smart-list":"dianjoy.component.SmartList",".smart-slide":"dianjoy.component.SmartSlide",".morris-chart":"tp.component.MorrisChart",".article-editor":"dianjoy.component.ArticleEditor","#login-form":"tp.component.LoginForm",form:"tp.component.SmartForm"},check:function(a,b){var c=[];a.data("components",c),a.popover({html:!0,selector:".has-popover"});var d=this;for(var e in this.map)if(this.map.hasOwnProperty(e)){var f=a.find(e);if(f.length){var g={model:b},h=Nervenet.parseNamespace(this.map[e]);h?f.each(function(){g.el=this,c.push(d.$context.createInstance(h,g))}):this.loadMediatorClass(c,this.map[e],g,f)}}a.find("[data-mediator-class]").each(function(){var a=$(this).data("mediator-class"),e=Nervenet.parseNamespace(a),f={model:b};e?(f.el=this,c.push(d.$context.createInstance(e,f))):d.loadMediatorClass(c,a,f,$(this),!0)})},clear:function(a){var b=a.data("components");if(b&&0!==b.length){for(var c=0,d=b.length;d>c;c++)b[c].remove();b.length=0}},find:function(a,b){var c=a.data("components");if(c){var d=[];b=Nervenet.parseNamespace(b);for(var e=0,f=c.length;f>e;e++)c[e]instanceof b&&d.push(c[e]);return d}},getPath:function(a,b){var c=a.split(".");return b?c.join("/")+".js":("tp"===c[0]&&(c=c.slice(1)),"js/"+c.join("/")+".js")},loadMediatorClass:function(a,b,c,d,e){var f=this,g=document.createElement("script");g.async=!0,g.src=this.getPath(b,e),g.onload=function(){this.onload=null;var e=Nervenet.parseNamespace(b);if(!e)throw new Error("cannot find mediator");d.each(function(){c.el=this,a.push(f.$context.createInstance(e,c))})},document.head.appendChild(g)},preCheck:function(a){var b=a.data("components");if(!b)return!0;for(var c=0,d=b.length;d>c;c++)if("preCheck"in b[c]&&!b[c].preCheck())return!1;return!0}}}(Nervenet.createNameSpace("tp.component")),function(a){var b,c='<p><i class="fa fa-spinner fa-spin fa-4x"></i></p>';a.Base=tp.view.DataSyncView.extend({$context:null,events:{"shown.bs.modal":"shownHandler","hidden.bs.modal":"hiddenHandler","loaded.bs.modal":"loadCompleteHandler","click .modal-footer .btn-primary":"submitButton_clickHandler","click [data-dismiss=modal]":"closeButton_clickHandler",keydown:"keydownHandler",success:"form_successHandler"},initialize:function(a){a.isRemote?(this.$el.addClass("loading").find(".modal-body").html(c),/\.hbs/.test(a.content)?$.get(a.content,_.bind(this.template_loadedHandler,this)):$.get(a.content,_.bind(this.onLoadComplete,this)),ga("send","pageview",a.content)):this.onLoadComplete(a.content),this.options=a,this.$el.modal(a)},remove:function(){clearTimeout(b),this.options=null,this.off(),Backbone.View.prototype.remove.call(this)},hide:function(){var a=this.$el;b=setTimeout(function(){a.modal("hide")},3e3)},onLoadComplete:function(a){a&&this.$(".modal-body").html(a),this.$el.removeClass("loading").find(".modal-footer .btn-primary").prop("disabled",!1),tp.component.Manager.check(this.$el,this.model)},closeButton_clickHandler:function(){this.$el.modal("hide"),this.trigger("cancel")},form_successHandler:function(){this.hide(),this.trigger("success")},submitButton_clickHandler:function(a){a.currentTarget.form||this.$el.modal("hide"),this.trigger("confirm")},template_loadedHandler:function(a){this.template=Handlebars.compile(a);var b=_.extend({API:tp.API},this.options,this.model?this.model.toJSON():null);this.onLoadComplete(this.template(b))},hiddenHandler:function(){this.remove()},keydownHandler:function(a){13===a.keyCode&&a.ctrlKey&&(this.$(".modal-footer .btn-primary").submit(),a.preventDefault())},loadCompleteHandler:function(){this.onLoadComplete()},shownHandler:function(){this.$(".modal-footer .btn-primary").prop("disabled",!1)}})}(Nervenet.createNameSpace("tp.popup")),function(a){var b,c=a.Editor=tp.view.DataSyncView.extend({$context:null,form:null,events:{"hidden.bs.modal":"hiddenHandler",keydown:"keydownHandler","mousedown .input-group":"inputGroup_mouseDownHandler"},initialize:function(a){this.submit=this.$(".btn-primary"),this.options=a;var b=a.type||"short-text",c=tp.path+(a.template?"page/"+a.template:"template/popup-"+b);$.get(c+".hbs",_.bind(this.loadCompleteHandler,this),"html");var d=$(".editor-info");d.length&&(d=Handlebars.compile(d.html()),this.$(".info").html(d(this.model.toJSON()))),this.$el.modal(a)},render:function(a){a=Handlebars.compile(a),this.$(".loading").remove(),this.form=new tp.component.SmartForm({tagName:"form",id:"prop-editor",className:"editor-form model-editor",model:this.model}),this.form.$el.html(a(_.extend(this.model.toJSON(),this.options))).insertAfter(this.$(".alert-msg")),this.form.on("success",this.form_successHandler,this),this.form.on("error",this.form_errorHandler,this);var b=this.$(".item-grid").html();b&&(this.template=Handlebars.compile(b),this.$(".item-grid").empty());var c=this.$("[type=datetime]");c.length&&c.each(function(){$(this).datetimepicker($(this).data())}),this.submit.prop("disabled",!1)},hide:function(a){a=void 0===a?3e3:a;var c=this.$el;b=setTimeout(function(){c.modal("hide")},a)},form_errorHandler:function(a,b,c){this.displayResult(!1,c.message,"frown-o"),this.trigger("error",a,b,c)},form_successHandler:function(a){this.displayResult(!0,a.msg,"smile-o"),this.trigger("success",a),this.hide()},inputGroup_mouseDownHandler:function(a){$(a.currentTarget).find("[type=radio]").prop("checked",!0)},keydownHandler:function(a){13===a.keyCode&&a.ctrlKey&&(this.form.$el.submit(),a.preventDefault())},loadCompleteHandler:function(a){this.render(a);

},hiddenHandler:function(){this.form.remove(),this.collection&&this.collection instanceof Backbone.Collection&&this.collection.off(null,null,this),clearTimeout(b),this.$el.remove(),this.trigger("hidden")}});a.SearchEditor=c.extend({fragment:"",events:_.extend(c.prototype.events,{"click .search-button":"searchButton_clickHandler"}),initialize:function(a){c.prototype.initialize.call(this,a),this.collection.on("add",this.collection_addHandler,this),this.collection.on("sync",this.collection_syncHandler,this)},render:function(a){c.prototype.render.call(this,a)},search:function(){var a=this.$("[type=search]").val();a&&(this.collection.fetch({data:{keyword:a}}),this.$("[type=search], .search-button").prop("disabled",!0))},collection_addHandler:function(a){this.fragment+=this.template(a.toJSON())},collection_syncHandler:function(){this.$(".search-result").html(this.fragment+"<hr />"),this.$("[type=search], .search-button").prop("disabled",!1),this.fragment=""},searchButton_clickHandler:function(){this.search()},keydownHandler:function(a){c.prototype.keydownHandler.call(this,a),13===a.keyCode&&"search"===a.target.type&&""!=a.target.value&&(this.search(),a.preventDefault())}}),a.TagsEditor=c.extend({events:_.extend(c.prototype.events,{"click .add-button":"addButton_clickHandler"}),initialize:function(a){c.prototype.initialize.call(this,a),this.collection.on("add",this.collection_addHandler,this)},render:function(a){if(c.prototype.render.call(this,a),this.options.tag&&this.collection){var b=this.options.tag;this.collection.map(function(a){a.set("tag",a.get(b))})}this.$(".item-grid").html(this.template({value:this.collection.toJSON()}))},add:function(){var a=this.$("[name=query]").val().replace(/^\s+|\s+$/,"");a&&!this.collection.find({tag:a})&&(this.$("[name=query], .add-button").prop("disabled",!0),this.$(".add-button i").addClass("fa-spin fa-spinner"),this.collection.create({tag:a},{wait:!0}))},addButton_clickHandler:function(){this.add()},collection_addHandler:function(a){var b=a.toJSON();b.index=this.collection.length-1,$(this.template({value:[b],append:!0})).insertBefore(this.$("hr")),this.$("[name=query],.add-button").prop("disabled",!1).val(""),this.$(".add-button i").removeClass("fa-spin fa-spinner")},keydownHandler:function(a){13===a.keyCode&&""!=a.target.value&&(this.add(),a.preventDefault())}}),a.SelectEditor=c.extend({render:function(a){this.options.options&&(this.options.options=this.model.options?this.model.options[this.options.options]:this.model.collection.options[this.options.options]),c.prototype.render.call(this,a),this.options.list&&this.$("select").html($(this.options.list).html()),this.$("select").val(this.options.value)}}),a.NumberEditor=c.extend({initialize:function(a){a.range="range"===a.type,a.type="number",c.prototype.initialize.call(this,a)}}),a.FileEditor=c.extend({events:_.extend({"click [data-dismiss]":"clickHandler"},c.prototype.events),initialize:function(a){a.isImage=/image\/\*/.test(a.accept),a.API=tp.API,a.multiple&&(a.items=a.value.split(",")),a.backdrop="static",a.keyboard=!1,c.prototype.initialize.call(this,a)},render:function(a){c.prototype.render.call(this,a),this.form.initUploader()},clickHandler:function(a){var b="您有文件正在上传，关闭窗口将导致上传失败。您确认要继续关闭窗口么？";this.form.$el.hasClass("loading")&&!confirm(b)&&a.stopPropagation()}}),a.SwitchEditor=c.extend({initialize:function(a){a.value=this.model.get(a.prop)!=a.open,c.prototype.initialize.call(this,a)}}),a.CheckboxEditor=c.extend({render:function(a){this.options.options&&(this.options.options=this.model.options?this.model.options[this.options.options]:this.model.collection.options[this.options.options]),c.prototype.render.call(this,a)}})}(Nervenet.createNameSpace("tp.popup")),function(a){a.Loader=Backbone.View.extend({$context:null,fresh:!1,tagName:"div",events:{"click .edit":"edit_clickHandler"},initialize:function(a){this.model instanceof Backbone.Model&&!a.hasData?(this.model.once("sync",this.model_syncHandler,this),this.model.fetch()):this.isModelReady=!0,$.get(a.template,_.bind(this.template_getHandler,this),"html"),"fresh"in a&&(this.fresh=a.fresh)},render:function(){this.$el.html(this.template(this.model instanceof Backbone.Model?this.model.toJSON():this.model)),this.fresh&&(this.fresh=!1,this.model.on("change",this.model_changeHandler,this));var a=this,b=this.$el,c=this.model;setTimeout(function(){tp.component.Manager.check(b,c),a.trigger("complete")},0)},edit_clickHandler:function(a){var b=$(a.currentTarget),c=b.data(),d=a.currentTarget.hash.substr(1);c.label=c.label||b.closest("td").prev("th").text(),this.$context.trigger("edit-model",this.model,d,c),a.preventDefault()},model_changeHandler:function(){var a=this.$(".active").filter(".tab-pane").attr("id");tp.component.Manager.clear(this.$el),this.render(),a&&this.$("[href=#"+a+"][data-toggle]").click()},model_syncHandler:function(){return this.template?this.render():void(this.isModelReady=!0)},template_getHandler:function(a){this.template=Handlebars.compile(a),this.isModelReady&&this.render()}})}(Nervenet.createNameSpace("tp.view")),function(a){a.Body=Backbone.View.extend({$context:null,events:{"change [type=range]":"range_changeHandler","click .add-button":"addButton_clickHandler"},initialize:function(){this.framework=this.$(".framework"),this.container=this.$("#page-container"),this.loading=this.$("#page-loading").remove().removeClass("hide"),this.loadCompleteHandler=_.bind(this.loadCompleteHandler,this),this.model.on("change:fullname",this.model_nameChangeHandler,this)},clear:function(){tp.component.Manager.clear(this.$el)},createSidebar:function(){this.template=this.template||Handlebars.compile(this.$("#navbar-side-inner").find("script").remove().html()),this.$(".sidebar-nav-item").remove();var a=this.model.get("sidebar")?this.model.get("sidebar"):"default",b=this.template;$.getJSON("page/sidebar/"+a+".json",function(a){var c=b({list:a});$("#navbar-side-inner").append(c)})},load:function(a,b,c){if(c=c||{},this.clear(),this.$el.toggleClass("full-page",!!c.isFull).removeClass(this.lastClass),/.hbs$/.test(a)){var d=c.loader||tp.view.Loader,e=this.$context.createInstance(d,_.extend({template:a,model:b},c));this.container.html(e.$el),e.once("complete",this.page_loadCompleteHandler,this)}else this.container.load(a,this.loadCompleteHandler);return this.container.append(this.loading),this.trigger("load:start",a),ga("send","pageview",a),this},setFramework:function(a,b){return this.$el.addClass(a),this.lastClass=a,this.$("#content h1").text(b),this},start:function(a){this.isStart=!0,this.$("#page-preloader").remove(),a&&(this.createSidebar(),this.$el.removeClass("full-page").find(".login").remove())},addButton_clickHandler:function(a){var b=$(a.currentTarget).data();!b.title&&a.currentTarget.title&&(b.title=a.currentTarget.title),b.collectionId=a.currentTarget.hash.substr(1),this.$context.trigger("add-model",b),a.preventDefault()},model_nameChangeHandler:function(a,b){this.$(".username").html(b)},range_changeHandler:function(a){$(a.target).next().html(a.target.value)},page_loadCompleteHandler:function(){this.loading.remove()},loadCompleteHandler:function(a,b){"error"===b?this.trigger("load:failed"):tp.component.Manager.check(this.container),this.loading.remove(),this.trigger("load:complete")}})}(Nervenet.createNameSpace("tp.view")),function(a){var b="itms-apps://";a.AdEditor=tp.view.Loader.extend({events:{"blur [name=ad_url]":"adURL_blurHandler","change [name=ad_app_type]":"platform_changeHandler","change [name=search_flag]":"searchFlag_changeHandler","change [name=replace-with]":"replaceWith_changeHandler","change #replace-ad":"replaceAD_changeHandler","change .domestic input":"area_changeHandler","change .isp input":"isp_changeHandler","change #feedback":"feedback_changeHandler","change #app-uploader [name=ad_url]":"adURL_changeHandler"},render:function(){tp.view.Loader.prototype.render.call(this);var a=this.model.pick(_.keys(this.model.defaults));for(var b in a)if(a.hasOwnProperty(b)){var c=this.$("[name="+b+"][value="+a[b]+"]").prop("checked",!0);c.length>0||(c=this.$('[name="'+b+'[]"][value='+a[b]+"]").prop("checked",!0)),c.length>0||this.$("[name="+b+"]").val(a[b])}},remove:function(){Backbone.View.prototype.remove.call(this),this.model.off(null,null,this)},checkADURL:function(a){return/\.ipa$/.test(a)||/itunes.apple.com/.test(a)?void this.$("input[name=ad_app_type][value=2]").prop("checked",!0):void(/\.apk$/.test(a)&&this.$("input[name=ad_app_type][value=1]").prop("checked",!0))},adURL_blurHandler:function(a){this.$el.hasClass("iPhone")&&a.target.value.substr(0,12)!==b&&(a.target.value=a.target.value.replace(/^https?:\/\//i,b))},adURL_changeHandler:function(a){this.checkADURL(a.target.value)},area_changeHandler:function(a){var b=$(a.target);this.$el.toggleClass(b.data("class"),"1"===b.val())},feedback_changeHandler:function(a){this.$el.toggleClass("show-feedback-detail","2"===a.target.value||"3"===a.target.value)},fetchAD_errorHandler:function(){alert("加载已有广告失败"),this.$("#replace-ad").prop("disabled",!1).next().removeClass("spin")},fetchAD_successHandler:function(a){var b=Handlebars.compile('{{#each list}}<option value="{{id}}">{{channel}} {{ad_name}} {{cid}}</option>{{/each}}'),c=b(a);this.hasAD=!0,this.replace=a,this.$("[name=replace-with]").html(c),this.$("[name=replace-with],#replace-time,#replace-ad").prop("disabled",!1),this.$("#replace-ad").next().removeClass("spin"),this.$("form").trigger("data",_.omit(a.list[0],"ad_url","ad_lib","ad_size","id","pack_name"))},isp_changeHandler:function(a){var b=$(a.target),c=a.target.value,d=a.target.checked;d?"0"===c?b.siblings().prop("checked",!1):b.siblings().first().prop("checked",!1):"0"===c?b.siblings().prop("checked",!0):0===b.siblings().filter(":checked").length&&b.siblings().first().prop("checked",!0)},platform_changeHandler:function(a){this.$("form").removeClass("Android iPhone").addClass(a.target.labels[0].innerText);var b="2"===a.target.value;this.$("#process_name").prop("required",b),$("#feedback").val(function(){return b?4:this.value}),$("#app-uploader").data("accept",b?"*.ipa":"*.apk")},replaceAD_changeHandler:function(a){var b=a.target.checked,c=this.model.get("pack_name")||this.$("[name=pack_name]").val();return b&&!c?(alert("包名未知，请先上传安装包，或填写包名"),void(a.target.checked=!1)):b&&!this.hasAD?(tp.service.Manager.call(tp.API+"ad/",{pack_name:c,status:0},{success:this.fetchAD_successHandler,error:this.fetchAD_errorHandler,context:this,method:"get"}),this.$("#replace-time").datetimepicker({format:"YYYY-MM-DD HH:mm"}),a.target.disabled=!0,void $(a.target).next().addClass("spin")):void this.$("[name=replace-with],#replace-time,#replace-ad").prop("disabled",!b)},replaceWith_changeHandler:function(a){var b=_.omit(this.replace.list[a.target.selectedIndex],"id","ad_lib","ad_size","ad_url","pack_name");this.$("form").trigger("data",b)},searchFlag_changeHandler:function(a){this.$(".aso").toggle("1"===a.target.value)}})}(Nervenet.createNameSpace("tp.page")),function(a){a.LoginForm=Backbone.View.extend({events:{"click #verify-code":"verifyCode_clickHandler"},verifyCode_clickHandler:function(a){var b=a.target.src,c=b.indexOf("?ts="),d=Date.now();b=-1===c?b+"?ts="+d:b.replace(/\?ts=\d+$/,"?ts="+d),a.target.src=b}})}(Nervenet.createNameSpace("tp.component")),function(a){a.MorrisChart=Backbone.View.extend({$colors:null,initialize:function(a){var b=JSON.parse(this.$("script").remove().html().replace(/,\s?]/,"]"));return b.data.length<=1?void this.$el.addClass("empty").text("（无数据）"):(this.createOptions(a,b),void this.drawChart())},createOptions:function(a,b){var c=this.$el.data();a=_.extend({element:this.el,lineWidth:2},a,b,c),this.className="type"in a?a.type.charAt(0).toUpperCase()+a.type.substr(1):"Line",a.colors=a.lineColors=a.barColors="colors"in a?a.colors.split(","):this.$colors,"Donut"===this.className&&(a.formatter=function(a,b){return"percent"in b?a+"("+b.percent+"%)":a}),this.options=a},drawChart:function(){this.chart=new Morris[this.className](this.options)}})}(Nervenet.createNameSpace("tp.component")),function(a){var b={events:{"change .auto-submit":"autoSubmit_Handler","click .add-row-button":"addRowButton_clickHandler"},initialize:function(){var a=this.$el.data("collection-id");a&&(this.collection=tp.model.ListCollection.createInstance(null,{id:a})),this.render()},render:function(){this.$(".keyword-form").find("[name=query]").val(this.model.get("keyword"))},addRowButton_clickHandler:function(a){this.collection.add({}),a.preventDefault()},autoSubmit_Handler:function(a){$(a.currentTarget).closest("form").submit()}};a.SmartNavbar=Backbone.View.extend(b)}(Nervenet.createNameSpace("tp.component")),function(a){var b=Handlebars.compile('<a href="#/{{key}}/{{value}}" class="filter label label-{{key}}">{{value}}</a>');a.SmartTable=a.BaseList.extend({$context:null,events:{"click .add-row-button":"addRowButton_clickHandler","click .delete-button":"deleteButton_clickHandler","click .edit":"edit_clickHandler","click tbody .filter":"tbodyFilter_clickHandler","click thead .filter":"theadFilter_clickHandler","click .order":"order_clickHandler","change select.edit":"select_changeHandler","change .stars input":"star_changeHandler","change .status-button":"statusButton_clickHandler"},initialize:function(b){var c=this.$el.data();c.url=c.url.replace("{{API}}",tp.API),b=_.extend({pagesize:10,autoFetch:!0},b,c),c.model&&(b.model=Nervenet.parseNamespace(c.model)),this.params=tp.utils.decodeURLParam(c.params),this.collection=tp.model.ListCollection.getInstance(b),a.BaseList.prototype.initialize.call(this,{container:"tbody"}),this.model=this.model&&this.model instanceof tp.model.TableMemento?this.model:new tp.model.TableMemento,this.model.on("change",this.model_changeHandler,this),this.model.on("invalid",this.model_invalidHandler,this),this.renderHeader(),"search"in c&&(this.search=new a.table.Search({el:c.search,model:this.model,collection:this.collection})),"pagesize"in c&&c.pagesize>0&&(this.pagination=new a.table.Pager(_.extend({},b,{el:"pagination"in c?c.pagination:".pager",model:this.model,collection:this.collection}))),"pagesizeController"in c&&(this.pagesizeController=$(c.pagesizeController),this.pagesizeController.val(this.collection.pagesize),this.pagesizeController.on("change",_.bind(this.pagesize_changeHandler,this))),"ranger"in c&&(this.ranger=new a.table.Ranger(_.extend({},b,{el:c.ranger,model:this.model}))),"filter"in c&&(this.filter=new a.table.Filter({el:c.filter,model:this.model,collection:this.collection})),b.autoFetch&&this.collection.fetch({data:_.extend(this.model.toJSON(),this.params)})},remove:function(){this.pagination&&this.pagination.remove(),this.pagesizeController&&this.pagesizeController.off("change"),this.ranger&&this.ranger.remove(),this.filter&&this.filter.remove(),this.model.off(null,null,this),tp.model.ListCollection.destroyInstance(this.$el.data("collection-id")),a.BaseList.prototype.remove.call(this)},render:function(){if(a.BaseList.prototype.render.call(this),this.$context.trigger("table-rendered"),"order"in this.model.changed||"seq"in this.model.changed){var b=this.container;this.collection.each(function(a){b.append(b.find("#"+a.id))})}},renderHeader:function(){var a=this.model.get("order"),c=this.model.get("seq"),d=this.model.omit("keyword","order","seq"),e="";a&&(this.$(".order").removeClass("active inverse"),this.$(".order[href=#"+a+"]").addClass("active").toggleClass("inverse","desc"==c)),_.each(d,function(a,c){e+=b({key:c,value:a})}),this.$(".filters").append(e)},saveModel:function(a,b,c,d){a.prop("disabled",!0),this.collection.get(b).save(c,d,{patch:!0,wait:!0,success:function(){a.prop("disabled",!1)}})},addRowButton_clickHandler:function(a){var b=$(a.currentTarget).data("prepend");this.collection.add(null,{immediately:!0,prepend:!!b})},collection_syncHandler:function(){a.BaseList.prototype.collection_syncHandler.call(this),this.model.waiting=!1},deleteButton_clickHandler:function(a){var b=$(a.currentTarget),c=b.data("msg");if(c=c||"确定删除么？",confirm(c)){var d=b.closest("tr").attr("id");b.prop("disabled",!0).find("i").addClass("fa-spin fa-spinner"),this.collection.get(d).destroy({fadeOut:!0,wait:!0,error:function(a,c){var d="responseJSON"in c?c.responseJSON:c;b.prop("disabled",!1).find("i").removeClass("fa-spin fa-spinner"),alert(d.msg||"删除失败")}}),a.preventDefault()}},edit_clickHandler:function(a){if("select"!==a.currentTarget.tagName.toLowerCase()){var b=$(a.currentTarget),c=b.data(),d=b.closest("td").index(),e=a.currentTarget.hash.substr(1),f=b.closest("tr").attr("id"),g=this.collection.get(f),h=_.extend({label:this.$("thead th").eq(d).text()},c);h.type=c.type||"short-text",this.$context.trigger("edit-model",g,e,h),a.stopPropagation(),a.preventDefault()}},model_changeHandler:function(a,b){b=b||{},b.data=_.extend(a.toJSON(),this.params),this.collection.fetch(b),this.$el.addClass("loading"),a.warting=!0},model_invalidHandler:function(a,b){alert(b)},order_clickHandler:function(a){var b=$(a.currentTarget),c=b.attr("href").substr(1);this.$(".order.active").not(b).removeClass("active inverse"),b.toggleClass("inverse",b.hasClass("active")&&!b.hasClass("inverse")).addClass("active"),this.model.set({order:c,seq:b.hasClass("inverse")?"desc":"asc"}),a.preventDefault()},pagesize_changeHandler:function(a){this.collection.setPagesize(a.target.value),this.collection.fetch({data:_.extend(model.toJSON(),this.params)})},select_changeHandler:function(a){var b=$(a.currentTarget),c=b.closest("tr").attr("id");this.saveModel(b,c,b.attr("name"),b.val())},star_changeHandler:function(a){var b=$(a.currentTarget),c=b.closest("tr").attr("id");this.saveModel(b.add(b.siblings(".star")),c,b.attr("name"),b.val())},statusButton_clickHandler:function(a){var b=$(a.currentTarget),c=_.extend({active:1,deactive:0},b.data()),d=b.prop("checked")?c.deactive:c.active,e=b.closest("tr").attr("id");this.saveModel(b,e,b.attr("name"),d)},tbodyFilter_clickHandler:function(a){var b=$(a.currentTarget),c=b.attr("href").split("/").slice(-2),d=this.model.has(c[0]);this.model.set(c[0],c[1]),d?this.$(".filters").find('[href="#/'+c[0]+'"]').replaceWith(b.clone()):this.$(".filters").append(b.clone()),a.preventDefault()},theadFilter_clickHandler:function(a){var b=$(a.currentTarget),c=b.attr("href").split("/").slice(-2);this.model.unset(c[0]),b.remove(),a.preventDefault()}})}(Nervenet.createNameSpace("tp.component"))}();